<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lattice — CoreWeave Workforce Intelligence</title>

<!-- Open Graph / LinkedIn preview -->
<meta property="og:type" content="website" />
<meta property="og:title" content="Lattice — CoreWeave Workforce Intelligence" />
<meta property="og:description" content="A working workforce intelligence prototype built for CoreWeave's four workforce segments — flight risk engine, AI-powered HRBP layer, and full product roadmap." />
<meta property="og:image" content="https://[your-github-username].github.io/lattice/preview.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://[your-github-username].github.io/lattice" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Lattice — CoreWeave Workforce Intelligence" />
<meta name="twitter:description" content="A working workforce intelligence prototype built for CoreWeave's four workforce segments — flight risk engine, AI-powered HRBP layer, and full product roadmap." />
<meta name="twitter:image" content="https://[your-github-username].github.io/lattice/preview.png" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500&display=swap');

  :root {
    --red: #0057FF;
    --red-dim: #003BAD;
    --black: #070C18;
    --surface: #0D1525;
    --surface2: #131E32;
    --surface3: #1A2740;
    --border: #1C2D47;
    --text: #E6EDF8;
    --text-dim: #7A93BC;
    --text-muted: #3D5275;
    --green: #2ECC71;
    --amber: #F39C12;
    --blue: #3498DB;
    --purple: #9B59B6;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .shell { display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 220px; min-width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    position: fixed; top: 0; left: 0; bottom: 0;
    z-index: 200;
  }

  .logo {
    padding: 22px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .logo-n { font-family: 'Syne', sans-serif; font-size: 28px; color: var(--red); line-height: 1; }
  .logo-text { font-size: 11px; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-dim); line-height: 1.4; }

  .nav { padding: 14px 0; flex: 1; overflow-y: auto; }
  .nav-section { padding: 8px 20px 4px; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); font-weight: 500; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 20px; cursor: pointer;
    color: var(--text-dim); font-size: 13px;
    border-left: 2px solid transparent;
    transition: all 0.15s;
  }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--text); border-left-color: var(--red); background: var(--surface2); font-weight: 500; }
  .nav-icon { font-size: 14px; width: 18px; text-align: center; }

  .sidebar-footer { padding: 14px 20px; border-top: 1px solid var(--border); }
  .avatar { width: 28px; height: 28px; background: var(--red); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; font-family: 'IBM Plex Mono', monospace; }

  /* Main */
  .main { margin-left: 220px; flex: 1; display: flex; flex-direction: column; min-width: 0; }

  .topbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 28px; height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .topbar-title { font-family: 'Syne', sans-serif; font-size: 18px; }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .badge-pill {
    background: var(--surface3); border: 1px solid var(--border);
    border-radius: 20px; padding: 4px 11px;
    font-size: 11px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace;
  }
  .badge-pill.live { border-color: var(--green); color: var(--green); }
  .badge-pill.live::before { content: '● '; font-size: 8px; }

  .content { padding: 24px 28px; }

  /* AI Bar */
  .ai-bar {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 14px 18px; margin-bottom: 14px;
    display: flex; align-items: center; gap: 14px;
    transition: border-color 0.2s;
  }
  .ai-bar:focus-within { border-color: var(--red); }
  .ai-bar-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red); font-weight: 600; white-space: nowrap; font-family: 'IBM Plex Mono', monospace; }
  .ai-input { flex: 1; background: none; border: none; outline: none; color: var(--text); font-family: 'IBM Plex Sans', sans-serif; font-size: 14px; }
  .ai-input::placeholder { color: var(--text-muted); }
  .ai-btn { background: var(--red); color: white; border: none; border-radius: 5px; padding: 7px 16px; font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.15s; white-space: nowrap; }
  .ai-btn:hover { background: #c0070f; }
  .ai-btn:disabled { background: var(--surface3); color: var(--text-muted); cursor: not-allowed; }

  .query-chips { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 20px; }
  .query-chip { padding: 5px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; font-size: 11px; color: var(--text-dim); cursor: pointer; transition: all 0.15s; }
  .query-chip:hover { border-color: var(--red); color: var(--text); }

  .ai-response {
    background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--red);
    border-radius: 6px; padding: 14px 18px; margin-bottom: 22px;
    font-size: 13px; line-height: 1.75; color: var(--text);
    display: none; animation: fadeIn 0.3s ease;
  }
  .ai-response.visible { display: block; }
  .ai-response-header { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red); font-family: 'IBM Plex Mono', monospace; margin-bottom: 8px; font-weight: 600; }

  .dot-pulse { display: flex; gap: 4px; align-items: center; }
  .dot-pulse span { width: 6px; height: 6px; background: var(--red); border-radius: 50%; animation: pulse 1.2s infinite; }
  .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
  .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse { 0%,80%,100% { opacity:0.2; transform:scale(0.8); } 40% { opacity:1; transform:scale(1); } }
  @keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }
  @keyframes slideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
  @keyframes overlayIn { from { opacity:0; } to { opacity:1; } }

  /* Segment Tabs */
  .seg-dot { width: 7px; height: 7px; border-radius: 50%; }

  /* KPI Row */
  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
  .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px 18px; position: relative; overflow: hidden; transition: border-color 0.2s, transform 0.15s; cursor: default; }
  .kpi-card:hover { border-color: var(--text-muted); }
  .kpi-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; }
  .kpi-card.green::after { background: var(--green); }
  .kpi-card.amber::after { background: var(--amber); }
  .kpi-card.red::after { background: var(--red); }
  .kpi-card.blue::after { background: var(--blue); }
  .kpi-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-family: 'IBM Plex Mono', monospace; }
  .kpi-value { font-family: 'Syne', sans-serif; font-size: 30px; line-height: 1; margin-bottom: 5px; transition: all 0.3s; }
  .kpi-sub { font-size: 11px; color: var(--text-dim); }
  .kpi-delta { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; margin-left: 4px; }
  .kpi-delta.up { background: rgba(46,204,113,0.15); color: var(--green); }
  .kpi-delta.down { background: rgba(229,9,20,0.15); color: var(--red); }

  /* Grid */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; margin-bottom: 14px; }

  /* Panel */
  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .panel-header { padding: 13px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .panel-title { font-size: 11px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; }
  .panel-action { font-size: 11px; color: var(--red); cursor: pointer; font-weight: 500; }
  .panel-body { padding: 14px 18px; }

  /* Risk Table */
  .risk-table { width: 100%; border-collapse: collapse; }
  .risk-table th { text-align: left; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); padding: 0 0 10px; border-bottom: 1px solid var(--border); font-weight: 500; font-family: 'IBM Plex Mono', monospace; }
  .risk-table td { padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
  .risk-table tr:last-child td { border-bottom: none; }
  .risk-table th:not(:first-child), .risk-table td:not(:first-child) { padding-left: 12px; }
  .risk-row { cursor: pointer; transition: background 0.15s; border-radius: 4px; }
  .risk-row:hover td { background: var(--surface2); }
  .risk-row:hover .name-cell { color: var(--red); }
  .name-cell { font-weight: 500; transition: color 0.15s; }
  .role-cell { color: var(--text-dim); font-size: 12px; margin-top: 1px; }

  .risk-bar-wrap { width: 80px; height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
  .risk-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

  .segment-chip { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; letter-spacing: 0.04em; font-family: 'IBM Plex Mono', monospace; }
  .chip-corporate { background: rgba(52,152,219,0.15); color: var(--blue); }
  .chip-studio { background: rgba(255,107,107,0.15); color: #ff6b6b; }
  .chip-union { background: rgba(155,89,182,0.15); color: var(--purple); }
  .chip-freelance { background: rgba(243,156,18,0.15); color: var(--amber); }

  /* Breakdown */
  .breakdown-list { display: flex; flex-direction: column; gap: 11px; }
  .breakdown-item { display: flex; flex-direction: column; gap: 5px; }
  .breakdown-meta { display: flex; justify-content: space-between; align-items: center; }
  .breakdown-name { font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
  .breakdown-count { font-size: 11px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; }
  .breakdown-track { height: 5px; background: var(--surface3); border-radius: 3px; overflow: hidden; }
  .breakdown-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

  /* Skills */
  .skills-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
  .skill-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 9px 11px; }
  .skill-name { font-size: 12px; font-weight: 500; margin-bottom: 6px; }
  .skill-track { height: 3px; background: var(--surface3); border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
  .skill-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
  .skill-meta { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }

  /* Alerts */
  .alert-list { display: flex; flex-direction: column; gap: 7px; }
  .alert-item { display: flex; align-items: center; gap: 11px; padding: 9px 11px; background: var(--surface2); border-radius: 5px; border: 1px solid var(--border); font-size: 12px; }
  .alert-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
  .alert-body { flex: 1; }
  .alert-title { font-weight: 500; margin-bottom: 2px; }
  .alert-sub { font-size: 11px; color: var(--text-dim); }
  .alert-days { font-family: 'IBM Plex Mono', monospace; font-size: 11px; white-space: nowrap; }

  /* Union */
  .union-list { display: flex; flex-direction: column; gap: 7px; }
  .union-item { display: flex; align-items: center; justify-content: space-between; padding: 9px 12px; background: var(--surface2); border-radius: 5px; border: 1px solid var(--border); }
  .union-name { font-size: 12px; font-weight: 500; }
  .union-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .union-status { display: flex; align-items: center; gap: 6px; font-size: 11px; font-family: 'IBM Plex Mono', monospace; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; }

  /* Chart containers */
  .chart-container { position: relative; height: 160px; margin-top: 8px; }

  /* Colors */
  .c-red { color: var(--red); }
  .c-green { color: var(--green); }
  .c-amber { color: var(--amber); }
  .c-blue { color: var(--blue); }
  .c-purple { color: var(--purple); }
  .bg-red { background: var(--red); }
  .bg-green { background: var(--green); }
  .bg-amber { background: var(--amber); }
  .bg-blue { background: var(--blue); }
  .bg-purple { background: var(--purple); }
  .dot-corporate { background: var(--blue); }
  .dot-studio { background: #ff6b6b; }
  .dot-union { background: var(--purple); }
  .dot-freelance { background: var(--amber); }

  /* Side Panel */
  .side-panel-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 500; display: none; animation: overlayIn 0.2s ease;
  }
  .side-panel-overlay.visible { display: block; }
  .side-panel {
    position: fixed; top: 0; right: 0; bottom: 0; width: 480px;
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 501; overflow-y: auto;
    animation: slideIn 0.3s ease;
    display: none;
  }
  .side-panel.visible { display: block; }
  .side-panel-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-start; justify-content: space-between;
    position: sticky; top: 0; background: var(--surface); z-index: 10;
  }
  .side-panel-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 20px; line-height: 1; padding: 0; transition: color 0.15s; }
  .side-panel-close:hover { color: var(--text); }
  .side-panel-body { padding: 20px 24px; }

  .sp-section { margin-bottom: 22px; }
  .sp-section-title { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 12px; font-weight: 600; }

  .sp-stat-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .sp-stat { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; }
  .sp-stat-label { font-size: 10px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 6px; letter-spacing: 0.06em; }
  .sp-stat-value { font-family: 'Syne', sans-serif; font-size: 22px; }

  .risk-factor-list { display: flex; flex-direction: column; gap: 8px; }
  .risk-factor { display: flex; align-items: center; gap: 10px; padding: 9px 12px; background: var(--surface2); border-radius: 5px; border: 1px solid var(--border); font-size: 12px; }
  .risk-factor-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .risk-factor-text { flex: 1; }
  .risk-factor-impact { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--text-dim); }

  .opportunity-list { display: flex; flex-direction: column; gap: 8px; }
  .opportunity-item { padding: 12px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: border-color 0.15s; }
  .opportunity-item:hover { border-color: var(--red); }
  .opp-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
  .opp-title { font-size: 12px; font-weight: 600; }
  .opp-type { font-size: 10px; font-family: 'IBM Plex Mono', monospace; padding: 2px 7px; border-radius: 3px; }
  .opp-type.internal { background: rgba(52,152,219,0.15); color: var(--blue); }
  .opp-type.external { background: rgba(46,204,113,0.15); color: var(--green); }
  .opp-type.learning { background: rgba(243,156,18,0.15); color: var(--amber); }
  .opp-desc { font-size: 11px; color: var(--text-dim); line-height: 1.5; }

  .action-row { display: flex; gap: 8px; margin-top: 16px; }
  .action-btn { flex: 1; padding: 10px; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--surface3); color: var(--text); transition: all 0.15s; text-align: center; }
  .action-btn:hover { border-color: var(--red); color: var(--red); }
  .action-btn.primary { background: var(--red); border-color: var(--red); color: white; }
  .action-btn.primary:hover { background: #c0070f; }

  /* Segment side panel */
  .seg-panel-header-meta { display: flex; gap: 8px; align-items: center; margin-top: 6px; flex-wrap: wrap; }

  /* Chart toggle */
  .chart-toggle-btn {
    padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 500;
    cursor: pointer; border: 1px solid var(--border); background: var(--surface2);
    color: var(--text-muted); transition: all 0.15s; font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 0.03em;
  }
  .chart-toggle-btn:hover { color: var(--text); border-color: var(--text-muted); }
  .chart-toggle-btn.active { background: var(--red); border-color: var(--red); color: white; }

  .page-view { flex: 1; }

  /* Risk page specific */
  .rr-filter-bar { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
  .rr-filter-select { background:var(--surface2); border:1px solid var(--border); border-radius:5px; padding:6px 12px; font-size:12px; color:var(--text); font-family:'DM Sans',sans-serif; outline:none; cursor:pointer; transition:border-color 0.15s; }
  .rr-filter-select:focus { border-color:var(--red); }
  .rr-filter-label { font-size:11px; color:var(--text-muted); font-family:'DM Mono',monospace; letter-spacing:0.06em; }
  .rr-search { background:var(--surface2); border:1px solid var(--border); border-radius:5px; padding:6px 12px; font-size:12px; color:var(--text); font-family:'DM Sans',sans-serif; outline:none; width:200px; transition:border-color 0.15s; }
  .rr-search:focus { border-color:var(--red); }
  .rr-search::placeholder { color:var(--text-muted); }

  .full-risk-table { width:100%; border-collapse:collapse; }
  .full-risk-table th { text-align:left; font-size:10px; letter-spacing:0.08em; text-transform:uppercase; color:var(--text-muted); padding:0 0 10px; border-bottom:1px solid var(--border); font-weight:500; font-family:'DM Mono',monospace; cursor:pointer; user-select:none; }
  .full-risk-table th:hover { color:var(--text); }
  .full-risk-table th .sort-icon { margin-left:4px; opacity:0.4; }
  .full-risk-table th.sorted .sort-icon { opacity:1; color:var(--red); }
  .full-risk-table td { padding:10px 0; border-bottom:1px solid var(--border); font-size:13px; vertical-align:middle; }
  .full-risk-table tr:last-child td { border-bottom:none; }
  .full-risk-table th:not(:first-child), .full-risk-table td:not(:first-child) { padding-left:14px; }
  .full-risk-table tbody tr { cursor:pointer; transition:background 0.12s; }
  .full-risk-table tbody tr:hover td { background:var(--surface2); }
  .full-risk-table tbody tr:hover .emp-name { color:var(--red); }
  .emp-name { font-weight:500; transition:color 0.12s; }
  .emp-role { color:var(--text-dim); font-size:11px; margin-top:1px; }

  .intervention-status { display:inline-flex; align-items:center; gap:5px; padding:3px 9px; border-radius:3px; font-size:10px; font-weight:600; font-family:'DM Mono',monospace; }
  .status-actioned { background:rgba(46,204,113,0.15); color:var(--green); }
  .status-pending { background:rgba(243,156,18,0.15); color:var(--amber); }
  .status-none { background:rgba(85,85,85,0.2); color:var(--text-muted); }
  .status-escalated { background:rgba(229,9,20,0.15); color:var(--red); }

  .risk-factor-tag { display:inline-block; padding:2px 7px; border-radius:3px; font-size:10px; background:var(--surface3); border:1px solid var(--border); color:var(--text-dim); margin:1px; font-family:'DM Mono',monospace; }

  .driver-card { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:14px 16px; }
  .driver-rank { font-family:'DM Serif Display',serif; font-size:28px; color:var(--red); opacity:0.4; line-height:1; margin-bottom:6px; }
  .driver-name { font-size:13px; font-weight:600; margin-bottom:4px; }
  .driver-desc { font-size:11px; color:var(--text-dim); line-height:1.6; margin-bottom:10px; }
  .driver-bar-wrap { height:4px; background:var(--surface3); border-radius:2px; overflow:hidden; margin-bottom:4px; }
  .driver-bar-fill { height:100%; border-radius:2px; background:var(--red); }
  .driver-impact { font-size:10px; color:var(--text-muted); font-family:'DM Mono',monospace; }

  .cohort-row { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
  .cohort-row:last-child { border-bottom:none; }
  .cohort-label { font-size:12px; font-weight:500; width:100px; flex-shrink:0; }
  .cohort-track { flex:1; height:8px; background:var(--surface3); border-radius:4px; overflow:hidden; }
  .cohort-fill { height:100%; border-radius:4px; transition:width 0.5s ease; }
  .cohort-pct { font-size:11px; font-family:'DM Mono',monospace; width:38px; text-align:right; flex-shrink:0; }
  .cohort-count { font-size:11px; color:var(--text-muted); width:70px; flex-shrink:0; }

  /* Segment health scorecard */
  .scorecard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
  .scorecard-cell { background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 10px 12px; display: flex; flex-direction: column; gap: 4px; }
  .scorecard-cell-label { font-size: 10px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.06em; text-transform: uppercase; }
  .scorecard-cell-value { font-size: 15px; font-weight: 600; font-family: 'Syne', sans-serif; line-height: 1.2; }
  .scorecard-cell-sub { font-size: 10px; color: var(--text-dim); }
  .scorecard-signal { display: flex; align-items: center; gap: 5px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; }
  .scorecard-signal-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

  /* ── Intelligence Agent Page ── */
  .agent-hero {
    background: linear-gradient(135deg, #111 0%, #1a0a0a 50%, #111 100%);
    border: 1px solid #2a0a0a;
    border-radius: 10px;
    padding: 28px 32px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .agent-hero::before {
    content: '';
    position: absolute;
    top: -60px; right: -60px;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(229,9,20,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  .agent-hero-label {
    font-size: 10px; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--red); font-family: 'IBM Plex Mono', monospace; font-weight: 600;
    margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
  }
  .agent-pulse {
    width: 7px; height: 7px; border-radius: 50%; background: var(--red);
    animation: agentPulse 2s infinite;
  }
  @keyframes agentPulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(229,9,20,0.4); }
    50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(229,9,20,0); }
  }
  .agent-hero-title {
    font-family: 'Syne', sans-serif;
    font-size: 26px; line-height: 1.2; margin-bottom: 6px;
  }
  .agent-hero-sub { font-size: 13px; color: var(--text-dim); line-height: 1.6; max-width: 600px; }
  .agent-meta { display: flex; gap: 16px; margin-top: 16px; flex-wrap: wrap; }
  .agent-meta-item {
    font-size: 11px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace;
    display: flex; align-items: center; gap: 5px;
  }
  .agent-meta-item span { color: var(--text-dim); }

  .agent-mode-tabs {
    display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 6px;
  }
  .agent-mode-tab {
    padding: 10px 18px; border-radius: 6px; font-size: 12px; font-weight: 600;
    cursor: pointer; border: 1px solid transparent; background: transparent;
    color: var(--text-muted); transition: all 0.18s; display: flex; align-items: center;
    gap: 8px; flex: 1; justify-content: center; min-width: 140px;
    font-family: 'IBM Plex Sans', sans-serif; letter-spacing: 0.01em;
  }
  .agent-mode-tab:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }
  .agent-mode-tab.active {
    background: var(--surface2); border-color: var(--border);
    color: var(--text);
    box-shadow: inset 0 0 0 1px var(--border);
  }
  .agent-mode-tab.active .agent-tab-label { color: var(--text); }
  .agent-mode-tab.active .agent-tab-badge {
    background: var(--red); color: white; border-color: var(--red);
  }
  .agent-tab-label { font-size: 12px; font-weight: 600; }
  .agent-tab-badge {
    font-size: 9px; font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.08em;
    padding: 2px 7px; border-radius: 3px; border: 1px solid var(--border);
    background: var(--surface3); color: var(--text-muted); font-weight: 600;
    text-transform: uppercase; transition: all 0.18s; white-space: nowrap;
  }
  .agent-mode-icon { font-size: 15px; opacity: 0.7; }

  .agent-output {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .agent-output.visible { display: block; }

  .agent-loading-screen {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 40px; text-align: center; margin-bottom: 16px;
  }
  .agent-loading-steps { display: flex; flex-direction: column; gap: 10px; max-width: 340px; margin: 20px auto 0; }
  .agent-step {
    display: flex; align-items: center; gap: 10px;
    font-size: 12px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace;
    transition: color 0.3s;
  }
  .agent-step.done { color: var(--green); }
  .agent-step.active { color: var(--text); }
  .agent-step-icon { font-size: 13px; width: 18px; text-align: center; flex-shrink: 0; }

  .insight-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    margin-bottom: 14px; overflow: hidden; transition: border-color 0.2s;
  }
  .insight-card:hover { border-color: var(--text-muted); }
  .insight-card-header {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; user-select: none;
  }
  .insight-card-header-left { display: flex; align-items: center; gap: 12px; }
  .insight-priority {
    width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 10px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;
    flex-shrink: 0;
  }
  .priority-critical { background: rgba(229,9,20,0.2); color: var(--red); border: 1px solid rgba(229,9,20,0.3); }
  .priority-high { background: rgba(243,156,18,0.2); color: var(--amber); border: 1px solid rgba(243,156,18,0.3); }
  .priority-medium { background: rgba(52,152,219,0.2); color: var(--blue); border: 1px solid rgba(52,152,219,0.3); }
  .insight-card-title { font-size: 13px; font-weight: 600; }
  .insight-card-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 3px;
    font-family: 'IBM Plex Mono', monospace; font-weight: 600; letter-spacing: 0.04em;
  }
  .badge-critical { background: rgba(229,9,20,0.15); color: var(--red); }
  .badge-high { background: rgba(243,156,18,0.15); color: var(--amber); }
  .badge-medium { background: rgba(52,152,219,0.15); color: var(--blue); }
  .badge-opportunity { background: rgba(46,204,113,0.15); color: var(--green); }
  .insight-chevron { color: var(--text-muted); font-size: 12px; transition: transform 0.2s; }
  .insight-chevron.open { transform: rotate(180deg); }

  .insight-card-body { padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s; }
  .insight-card-body.open { max-height: 800px; padding: 16px 20px; }

  .insight-finding {
    font-size: 13px; line-height: 1.75; color: var(--text); margin-bottom: 16px;
    padding-left: 12px; border-left: 2px solid var(--border);
  }
  .insight-actions { display: flex; flex-direction: column; gap: 8px; }
  .insight-action-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 12px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 5px; font-size: 12px; line-height: 1.5;
  }
  .insight-action-num {
    width: 20px; height: 20px; border-radius: 50%; background: var(--surface3);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--text-dim);
    flex-shrink: 0; margin-top: 1px;
  }
  .insight-action-text { flex: 1; }
  .insight-action-owner {
    font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted);
    margin-top: 3px;
  }
  .insight-action-due {
    font-size: 10px; font-family: 'IBM Plex Mono', monospace; padding: 2px 7px;
    border-radius: 3px; background: var(--surface3); color: var(--text-muted);
    white-space: nowrap; align-self: flex-start; margin-top: 1px;
  }

  .agent-refresh-btn {
    background: none; border: 1px solid var(--border); border-radius: 5px;
    padding: 6px 14px; font-size: 11px; color: var(--text-dim); cursor: pointer;
    font-family: 'IBM Plex Mono', monospace; transition: all 0.15s;
  }
  .agent-refresh-btn:hover { border-color: var(--red); color: var(--red); }

  .pattern-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .pattern-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 14px 16px;
  }
  .pattern-card-label { font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 6px; }
  .pattern-card-finding { font-size: 12px; line-height: 1.65; color: var(--text); }
  .pattern-card-signal { font-size: 11px; margin-top: 8px; font-family: 'IBM Plex Mono', monospace; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--black); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>
<div class="shell">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-n">C</div>
      <div style="display:flex;flex-direction:column;gap:1px"><div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text);letter-spacing:0.01em;line-height:1">Lattice</div><div style="font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);font-family:'IBM Plex Mono',monospace">by CoreWeave</div></div>
    </div>
    <nav class="nav">
      <div class="nav-section">Overview</div>
      <div class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard')"><span class="nav-icon">◈</span> Workforce Dashboard</div>
      <div class="nav-item" id="nav-risk" onclick="showPage('risk')"><span class="nav-icon">◎</span> Risk & Retention</div>
      <div class="nav-item" id="nav-agent" onclick="showPage('agent')"><span class="nav-icon" style="color:var(--red)">⬡</span> <span style="background:linear-gradient(90deg,#E50914,#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:600">Intelligence Agent</span></div>
      <div class="nav-section" style="margin-top:6px">Segments</div>
      <div class="nav-item" id="nav-seg-all" onclick="showPage('dashboard');closePanel();renderAll('all')"><span class="nav-icon" style="color:#0057FF">●</span> All Segments</div>
      <div class="nav-item" onclick="activateSegment('engineering')"><span class="nav-icon" style="color:#0057FF">●</span> Engineering & ML</div>
      <div class="nav-item" onclick="activateSegment('datacenter')"><span class="nav-icon" style="color:#00AAFF">●</span> Data Center Ops</div>
      <div class="nav-item" onclick="activateSegment('gtm')"><span class="nav-icon" style="color:var(--green)">●</span> GTM & Sales</div>
      <div class="nav-item" onclick="activateSegment('corporate')"><span class="nav-icon" style="color:var(--amber)">●</span> Corporate & G&A</div>
      <div class="nav-section" style="margin-top:6px">Programs</div>
      <div class="nav-item" id="nav-perf" onclick="showPage('perf')"><span class="nav-icon">△</span> Performance & Feedback</div>
      <div class="nav-item" id="nav-skills" onclick="showPage('skills')"><span class="nav-icon">◇</span> Skills & Development</div>
      <div class="nav-item" id="nav-legal" onclick="showPage('legal')"><span class="nav-icon" style="color:#0057FF">⬡</span> Contracts & Legal</div>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="avatar">SQ</div>
        <div>
          <div style="font-size:12px;color:var(--text);font-weight:500">Shehnoor Qureshi</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:1px">People Analytics Lead</div>
        </div>
      </div>
      <div style="font-size:9px;color:var(--text-muted);margin-top:10px;line-height:1.5;opacity:0.6">© 2026 Shehnoor Qureshi. All rights reserved.</div>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbar-page-title">Workforce Dashboard</div>
      <div class="topbar-right">
        <span class="badge-pill">Q1 2026</span>
        <span class="badge-pill live">Live Data</span>
        <span class="badge-pill" id="headcount-badge">1,871 employees</span>
        <span class="badge-pill" id="sync-badge" style="color:var(--text-muted);border-color:var(--border)">Synced today at 5:58 AM</span>
      </div>
    </div>

    <div id="page-dashboard" class="page-view">
    <div class="content">

      <!-- AI Bar -->
      <div class="ai-bar">
        <div class="ai-bar-label">AI Query</div>
        <input class="ai-input" id="aiInput" placeholder="e.g. Which studio roles are at risk ahead of the Q2 international slate ramp?" />
        <button class="ai-btn" id="aiBtn" onclick="runQuery()">Ask →</button>
      </div>

      <div class="query-chips">
        <div class="query-chip" onclick="setQuery('Which studio roles are at highest flight risk ahead of the Q2 international slate ramp?')">Flight risk — Q2 slate ramp</div>
        <div class="query-chip" onclick="setQuery('What skills gaps exist in post-production for the next slate?')">Skills gaps — next slate</div>
        <div class="query-chip" onclick="setQuery('Which union contracts are expiring in the next 90 days and what are the risks?')">Union contracts expiring</div>
        <div class="query-chip" onclick="setQuery('How does freelance headcount compare to the same period last year?')">Freelance headcount YoY</div>
        <div class="query-chip" onclick="setQuery('What development opportunities should we offer to retain corporate PMs at the 2-year mark?')">Corporate PM retention</div>
      </div>

      <div class="ai-response" id="aiResponse">
        <div class="ai-response-header">AI Insight</div>
        <div id="aiResponseText"></div>
      </div>

      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi-card green">
          <div class="kpi-label">Total Headcount</div>
          <div class="kpi-value" id="kpi-headcount">1,871</div>
          <div class="kpi-sub" id="kpi-headcount-sub">Across all segments <span class="kpi-delta up">+112% YoY</span></div>
        </div>
        <div class="kpi-card amber">
          <div class="kpi-label">Flight Risk (30-day)</div>
          <div class="kpi-value" id="kpi-risk">67</div>
          <div class="kpi-sub" id="kpi-risk-sub">Flagged by model <span class="kpi-delta down">+11 vs Q4</span></div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-label">L&amp;D Participation</div>
          <div class="kpi-value" id="kpi-contracts">61%</div>
          <div class="kpi-sub" id="kpi-contracts-sub">Active in L&D <span class="kpi-delta down">−6pts</span></div>
        </div>
        <div class="kpi-card blue">
          <div class="kpi-label">Open Reqs (Critical)</div>
          <div class="kpi-value" id="kpi-reqs">31</div>
          <div class="kpi-sub" id="kpi-reqs-sub">Blocking cluster launches <span class="kpi-delta down">+8</span></div>
        </div>
      </div>

      <!-- Row 2 -->
      <div class="grid-2">
        <!-- Breakdown + chart -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Workforce Segments</div>
            <div class="panel-action" onclick="showSegmentPanel('all')">View all →</div>
          </div>
          <div class="panel-body">
            <div class="breakdown-list" id="breakdown-list"></div>
            <div id="segment-scorecard" style="margin-top:16px"></div>
          </div>
        </div>

        <!-- Flight Risk Table -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Flight Risk — Top Signals</div>
            <div class="panel-action">Full report →</div>
          </div>
          <div class="panel-body" style="padding:0 18px">
            <table class="risk-table">
              <thead>
                <tr>
                  <th>Name / Role</th>
                  <th>Segment</th>
                  <th>Risk</th>
                  <th>Primary Signal</th>
                </tr>
              </thead>
              <tbody id="risk-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Row 3 -->
      <!-- Skills panel full width -->
      <div class="panel" style="margin-bottom:14px">
        <div class="panel-header">
          <div class="panel-title">Skills Gaps — Next Slate</div>
          <div class="panel-action">Full view →</div>
        </div>
        <div class="panel-body">
          <div class="skills-grid" id="skills-grid" style="grid-template-columns:repeat(6,1fr)"></div>
        </div>
      </div>

      <!-- Toggled Analytics Chart -->
      <div class="panel" style="margin-bottom:14px">
        <div class="panel-header">
          <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
            <div class="panel-title" id="chart-panel-title">Attrition Count by Segment — Last 6 Quarters</div>
            <div style="display:flex;gap:4px">
              <div class="chart-toggle-btn active" id="toggle-attrition" onclick="switchChart('attrition')">Attrition</div>
              <div class="chart-toggle-btn" id="toggle-flightrisk" onclick="switchChart('flightrisk')">Flight Risk</div>
              <div class="chart-toggle-btn" id="toggle-timetofill" onclick="switchChart('timetofill')">Time-to-Fill</div>
            </div>
          </div>
          <div class="panel-action">Export →</div>
        </div>
        <div class="panel-body">
          <div class="chart-container" style="height:200px">
            <canvas id="analyticsChart"></canvas>
          </div>
        </div>
      </div>

    </div>
    </div><!-- end page-dashboard -->
    <div id="page-agent" class="page-view" style="display:none">
    <div class="content" id="agent-content"></div>
    </div>

    <!-- Risk & Retention Page -->
    <div id="page-risk" class="page-view" style="display:none">
    <div class="content" id="risk-content"></div>
    </div>
    <div id="page-perf" class="page-view" style="display:none">
    <div class="content" id="perf-content"></div>
    </div>
    <div id="page-skills" class="page-view" style="display:none">
    <div class="content" id="skills-content"></div>
    </div>
    <div id="page-legal" class="page-view" style="display:none">
    <div class="content" id="legal-content"></div>
    </div>

  </div>
</div>

<!-- Side Panel Overlay -->
<div class="side-panel-overlay" id="overlay" onclick="closePanel()"></div>

<!-- Side Panel -->
<div class="side-panel" id="sidePanel">
  <div class="side-panel-header">
    <div>
      <div id="sp-title" style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700"></div>
      <div id="sp-subtitle" style="font-size:12px;color:var(--text-dim);margin-top:4px"></div>
      <div class="seg-panel-header-meta" id="sp-chips"></div>
    </div>
    <button class="side-panel-close" onclick="closePanel()">×</button>
  </div>
  <div class="side-panel-body" id="sp-body"></div>
</div>

<script>
// ─── DATA ────────────────────────────────────────────────────────────────────

const SEGMENTS = {
  all: {
    label: 'All Segments',
    headcount: 1871, risk: 67, contracts: '58%', reqs: 31,
    headcountSub: 'Across all segments',
    riskSub: 'Flagged by model',
    contractsSub: 'Active in L&D',
    reqsSub: 'Critical open reqs',
    headcountStatus: 'green', riskStatus: 'amber', contractsStatus: 'amber', reqsStatus: 'red',
  },
  engineering: {
    label: 'Engineering & ML',
    color: '#0057FF',
    headcount: 820, risk: 38, contracts: '54%', reqs: 18,
    headcountSub: 'Eng & ML engineers',
    riskSub: 'Flagged — eng segment',
    contractsSub: 'Active in L&D',
    reqsSub: 'Blocking cluster launches',
    headcountStatus: 'green', riskStatus: 'red', contractsStatus: 'amber', reqsStatus: 'red',
    description: 'Software engineers, ML engineers, and platform engineers building CoreWeave cloud infrastructure, Kubernetes orchestration, and AI workload tooling.',
    reviewCadence: 'Biannual + project milestone',
    compStructure: 'Salary + equity (pre/post-IPO)',
    notes: '⚠ Post-IPO equity cliff risk: 34% of this cohort vest in Q2 2026.',
  },
  datacenter: {
    label: 'Data Center Operations',
    color: '#00AAFF',
    headcount: 540, risk: 14, contracts: '49%', reqs: 9,
    headcountSub: 'DC ops technicians',
    riskSub: 'Flagged — DC segment',
    contractsSub: 'Active in L&D',
    reqsSub: 'Open DC technician reqs',
    headcountStatus: 'green', riskStatus: 'green', contractsStatus: 'red', reqsStatus: 'amber',
    description: "Data center technicians, network engineers, and facilities staff operating CoreWeave's 32 data centers across the US and Europe.",
    reviewCadence: 'Annual + safety certification',
    compStructure: 'Hourly + shift differential',
    notes: '⚠ Rapid DC expansion (13 → 32 facilities in 12 months) creating onboarding volume pressure.',
  },
  gtm: {
    label: 'GTM & Sales',
    color: '#2ECC71',
    headcount: 310, risk: 9, contracts: '71%', reqs: 3,
    headcountSub: 'GTM & sales employees',
    riskSub: 'Flagged — GTM segment',
    contractsSub: 'Active in L&D',
    reqsSub: 'Open GTM reqs',
    headcountStatus: 'green', riskStatus: 'green', contractsStatus: 'green', reqsStatus: 'green',
    description: 'Account executives, solutions engineers, and go-to-market leads managing enterprise AI lab and hyperscaler relationships. Microsoft accounts for 62% of revenue.',
    reviewCadence: 'Quarterly business review',
    compStructure: 'Base + commission + equity',
    notes: '⚠ Customer concentration risk: Microsoft >62% of revenue creates dependency on single-account relationships.',
  },
  corporate: {
    label: 'Corporate & G&A',
    color: '#F39C12',
    headcount: 201, risk: 6, contracts: '63%', reqs: 1,
    headcountSub: 'Corporate & G&A staff',
    riskSub: 'Flagged — G&A segment',
    contractsSub: 'Active in L&D',
    reqsSub: 'Open G&A reqs',
    headcountStatus: 'green', riskStatus: 'green', contractsStatus: 'amber', reqsStatus: 'green',
    description: "Finance, legal, HR, marketing, and operations staff supporting CoreWeave's post-IPO scaling. Team is growing rapidly to meet public company compliance requirements.",
    reviewCadence: 'Annual + quarterly pulse',
    compStructure: 'Salary + equity + bonus',
    notes: null,
  },
};

const ALL_EMPLOYEES = [
  { name: 'Aiden Park', role: 'Sr. ML Infrastructure Eng.', segment: 'engineering', risk: 89, signal: 'Equity cliff Q2 2026 + 3 recruiter contacts', tenure: '2.1 yrs', comp: '$285K (−9% vs band)', lastReview: '11 months ago', engagement: 'Low', location: 'Sunnyvale' },
  { name: 'Riya Desai', role: 'Staff Software Engineer', segment: 'engineering', risk: 76, signal: 'Comp below band + LinkedIn spike', tenure: '1.8 yrs', comp: '$310K (−12% vs band)', lastReview: '7 months ago', engagement: 'Low', location: 'New York' },
  { name: 'Marcus Chen', role: 'Sr. Account Executive', segment: 'gtm', risk: 61, signal: '2 internal transfer requests, no response', tenure: '2.4 yrs', comp: '$220K base (on band)', lastReview: '5 months ago', engagement: 'Medium', location: 'New York' },
  { name: 'Fatima Al-Hassan', role: 'DC Technician III', segment: 'datacenter', risk: 54, signal: 'No L&D activity 8mo + site expansion stress', tenure: '1.1 yrs', comp: '$92K (on band)', lastReview: '9 months ago', engagement: 'Medium', location: 'Ellendale, ND' },
  { name: 'Jake Morales', role: 'Platform Engineer', segment: 'engineering', risk: 49, signal: 'Post-IPO equity vested, 0 new grants issued', tenure: '3.2 yrs', comp: '$265K (on band)', lastReview: '4 months ago', engagement: 'Medium', location: 'Livingston, NJ' },
  { name: 'Priya Sundaram', role: 'Solutions Engineer', segment: 'gtm', risk: 43, signal: 'No promotion after 2 years in role', tenure: '2.0 yrs', comp: '$195K (on band)', lastReview: '6 months ago', engagement: 'Medium', location: 'San Francisco' },
  { name: 'Omar Khalil', role: 'DC Network Engineer', segment: 'datacenter', risk: 38, signal: 'Team reorg — reporting line changed', tenure: '1.5 yrs', comp: '$145K (on band)', lastReview: '5 months ago', engagement: 'Medium', location: 'Austin, TX' },
  { name: 'Nina Johansson', role: 'Sr. HR Business Partner', segment: 'corporate', risk: 31, signal: 'Workload spike post-IPO compliance build', tenure: '0.9 yrs', comp: '$175K (on band)', lastReview: '3 months ago', engagement: 'Medium', location: 'Livingston, NJ' },
];

const OPPORTUNITIES = {
  engineering: [
    { title: 'Staff Engineer Promotion Track', type: 'internal', desc: 'Structured path from Senior to Staff IC. Requires sponsoring VP, two completed cross-team initiatives, and design doc portfolio. Q3 cohort open.' },
    { title: 'Kubernetes & GPU Orchestration Cert.', type: 'learning', desc: "Internal 6-week program on CoreWeave's Kubernetes-native platform. Co-designed with Eng leadership. Priority for L5+ engineers." },
    { title: 'AI Infrastructure Rotation', type: 'internal', desc: 'Embed in a different infrastructure team (e.g., Networking → GPU Compute) for 90 days. Broadens impact and reduces single-team attrition clustering.' },
    { title: 'Post-IPO Equity Refresh Program', type: 'internal', desc: 'New grant cycle for engineers who vested pre-IPO RSUs. HRBP can initiate a comp review and refresh eligibility check.' },
  ],
  datacenter: [
    { title: 'DC Technician → Network Eng. Pathway', type: 'internal', desc: 'Structured upskill path for high-performing DC techs. 12-month program includes Cisco/Juniper cert sponsorship and shadow rotations.' },
    { title: 'Safety & OSHA Certification', type: 'learning', desc: 'Mandatory refresher for DC staff in new facilities. Covers high-density power, liquid cooling, and Blackwell hardware handling.' },
    { title: 'DC Site Lead Track', type: 'internal', desc: 'Internal management pathway for senior technicians at expansion sites. Includes people management training and P&L exposure.' },
    { title: 'AWS/GCP Fundamentals (External)', type: 'external', desc: 'Subsidized cloud fundamentals certification for DC ops staff. Broadens portability and signals investment in career growth.' },
  ],
  gtm: [
    { title: 'Enterprise AE → Director Track', type: 'internal', desc: 'Sponsorship-based path for top-quartile AEs into Director of Sales roles. Requires 2 consecutive quarters above quota.' },
    { title: 'Technical Sales Enablement', type: 'learning', desc: '4-week program covering GPU architecture, Kubernetes basics, and AI workload economics. Designed for AEs selling to ML infrastructure buyers.' },
    { title: 'Strategic Account Rotation', type: 'internal', desc: 'Rotate into a named strategic account team (e.g., Microsoft pod) for one quarter to build enterprise relationship skills.' },
    { title: 'Challenger Sale Certification', type: 'external', desc: 'Subsidized for all AEs and SEs. Particularly relevant for complex, multi-stakeholder AI infrastructure deals.' },
  ],
  corporate: [
    { title: 'Public Company Readiness Program', type: 'learning', desc: 'Onboarding program for G&A staff joining post-IPO. Covers SOX compliance, SEC reporting cadence, and IR fundamentals.' },
    { title: 'HRBP → Sr. HRBP Promotion Track', type: 'internal', desc: 'Structured advancement path with mentorship from VP People. Includes cross-functional project sponsorship and executive exposure.' },
    { title: 'Finance Rotation — FP&A', type: 'internal', desc: 'Open rotation for G&A finance staff into the FP&A team. Builds strategic finance skills and visibility with CFO org.' },
    { title: 'Kellogg Executive Education', type: 'external', desc: 'Subsidized for Director+ G&A leaders. Strategy and leadership programs relevant to scaling teams in hypergrowth environments.' },
  ],
};

const SKILLS_DATA = {
  all: [
    { name: 'GPU Architecture & Tuning', gap: 78, color: 'var(--red)' },
    { name: 'Kubernetes (Advanced)', gap: 65, color: 'var(--red)' },
    { name: 'AI/ML Infra Design', gap: 71, color: 'var(--red)' },
    { name: 'SOX Compliance', gap: 54, color: 'var(--amber)' },
    { name: 'Technical Sales', gap: 47, color: 'var(--amber)' },
    { name: 'Python / Go', gap: 38, color: 'var(--amber)' },
  ],
  engineering: [
    { name: 'GPU Architecture & Tuning', gap: 78, color: 'var(--red)' },
    { name: 'Kubernetes Operators', gap: 65, color: 'var(--red)' },
    { name: 'AI/ML Infra Design', gap: 71, color: 'var(--red)' },
    { name: 'Distributed Systems', gap: 58, color: 'var(--amber)' },
    { name: 'Observability (Grafana)', gap: 44, color: 'var(--amber)' },
    { name: 'Go / Rust', gap: 52, color: 'var(--amber)' },
  ],
  datacenter: [
    { name: 'Blackwell Hardware', gap: 82, color: 'var(--red)' },
    { name: 'Liquid Cooling Systems', gap: 69, color: 'var(--red)' },
    { name: 'High-Density Power', gap: 61, color: 'var(--red)' },
    { name: 'OSHA / Safety Certs', gap: 33, color: 'var(--amber)' },
    { name: 'Network Fundamentals', gap: 55, color: 'var(--amber)' },
    { name: 'Fiber Optic Cabling', gap: 28, color: 'var(--green)' },
  ],
  gtm: [
    { name: 'AI Infra Technical Sales', gap: 72, color: 'var(--red)' },
    { name: 'Enterprise Negotiation', gap: 48, color: 'var(--amber)' },
    { name: 'Kubernetes Fundamentals', gap: 65, color: 'var(--red)' },
    { name: 'Salesforce / CRM', gap: 29, color: 'var(--green)' },
    { name: 'Account Expansion', gap: 41, color: 'var(--amber)' },
    { name: 'Competitive Positioning', gap: 55, color: 'var(--amber)' },
  ],
  corporate: [
    { name: 'SOX Compliance', gap: 74, color: 'var(--red)' },
    { name: 'SEC Reporting', gap: 68, color: 'var(--red)' },
    { name: 'Executive Presence', gap: 42, color: 'var(--amber)' },
    { name: 'HRIS (Workday)', gap: 38, color: 'var(--amber)' },
    { name: 'FP&A Modeling', gap: 51, color: 'var(--amber)' },
    { name: 'OKR Facilitation', gap: 27, color: 'var(--green)' },
  ],
};

const CONTRACTS_DATA = {
  all: [
    { icon: '⚡', title: 'Equity Refresh Window', sub: '287 eng employees · Q2 2026', days: 14, color: 'var(--red)' },
    { icon: '🔒', title: 'SOX Audit Deadline', sub: 'G&A · FY2025 close', days: 28, color: 'var(--amber)' },
    { icon: '🏗️', title: 'DC Expansion Hiring', sub: '9 sites · 140 open reqs', days: 45, color: 'var(--amber)' },
    { icon: '📊', title: 'Post-IPO Comp Review', sub: 'All bands · Q3 reset', days: 90, color: 'var(--green)' },
  ],
  engineering: [
    { icon: '⚡', title: 'RSU Cliff — Eng Cohort', sub: '287 engineers · May 2026', days: 14, color: 'var(--red)' },
    { icon: '📋', title: 'New Hire Offer Letters', sub: '18 open reqs · Engineering', days: 30, color: 'var(--amber)' },
  ],
  datacenter: [
    { icon: '🏗️', title: 'DC Tech Onboarding', sub: '9 expansion sites · 140 reqs', days: 45, color: 'var(--amber)' },
    { icon: '🔐', title: 'Safety Cert Renewals', sub: '62 DC technicians due', days: 21, color: 'var(--amber)' },
  ],
  gtm: [
    { icon: '💼', title: 'Commission Plan Update', sub: 'All AEs · Q2 2026', days: 18, color: 'var(--amber)' },
    { icon: '📋', title: 'NDAs — Microsoft Pod', sub: '4 SEs · Renewal', days: 60, color: 'var(--green)' },
  ],
  corporate: [
    { icon: '🔒', title: 'SOX Audit Deadline', sub: 'Finance & Legal team', days: 28, color: 'var(--red)' },
    { icon: '📊', title: 'Comp Band Reset', sub: 'G&A benchmarking', days: 90, color: 'var(--green)' },
  ],
};

const UNION_DATA = [
  { name: 'Q2 Equity Refresh', sub: 'Eng & ML · 287 employees', status: 'Due May 2026', statusColor: 'var(--red)', dotClass: 'bg-red' },
  { name: 'SOX Audit Readiness', sub: 'G&A · Fiscal Year Close', status: 'In Progress', statusColor: 'var(--amber)', dotClass: 'bg-amber' },
  { name: 'DC Expansion Hiring', sub: '9 new sites · 140 open reqs', status: 'Active', statusColor: 'var(--green)', dotClass: 'bg-green' },
  { name: 'Post-IPO Comp Review', sub: 'All segments · Band resets', status: 'Planned Q3', statusColor: 'var(--amber)', dotClass: 'bg-amber' },
];

const BREAKDOWN_DATA = {
  all: [
    { name: 'Engineering & ML', count: 820, pct: 43.8, dotClass: 'dot-corporate', fillColor: '#0057FF' },
    { name: 'Data Center Ops', count: 540, pct: 28.9, dotClass: 'dot-studio', fillColor: '#00AAFF' },
    { name: 'GTM & Sales', count: 310, pct: 16.6, dotClass: 'dot-union', fillColor: 'var(--green)' },
    { name: 'Corporate & G&A', count: 201, pct: 10.7, dotClass: 'dot-freelance', fillColor: 'var(--amber)' },
  ],
  engineering: [
    { name: 'Platform & Infra Eng.', count: 340, pct: 41.5, dotClass: 'dot-corporate', fillColor: '#0057FF' },
    { name: 'ML Systems Eng.', count: 230, pct: 28.0, dotClass: 'dot-corporate', fillColor: '#3378FF' },
    { name: 'Networking Eng.', count: 150, pct: 18.3, dotClass: 'dot-corporate', fillColor: '#6699FF' },
    { name: 'Security & AppSec', count: 100, pct: 12.2, dotClass: 'dot-corporate', fillColor: '#99BBFF' },
  ],
  datacenter: [
    { name: 'DC Technicians (US)', count: 310, pct: 57.4, dotClass: 'dot-studio', fillColor: '#00AAFF' },
    { name: 'DC Technicians (EU)', count: 120, pct: 22.2, dotClass: 'dot-studio', fillColor: '#33BBFF' },
    { name: 'Facilities & EHS', count: 70, pct: 12.9, dotClass: 'dot-studio', fillColor: '#66CCFF' },
    { name: 'Network & Fiber Ops', count: 40, pct: 7.5, dotClass: 'dot-studio', fillColor: '#99DDFF' },
  ],

};

// ─── RENDER ──────────────────────────────────────────────────────────────────

let currentSegment = 'all';
let analyticsChart = null;
let currentChartType = 'attrition';
let trendChart = null;

function renderAll(seg) {
  currentSegment = seg;
  const s = SEGMENTS[seg];

  // KPIs
  animateValue('kpi-headcount', parseInt(document.getElementById('kpi-headcount').textContent.replace(/,/g,'')), s.headcount, 400);
  animateValue('kpi-risk', parseInt(document.getElementById('kpi-risk').textContent.replace(/,/g,'')), s.risk, 400);
  document.getElementById('kpi-contracts').textContent = s.contracts;
  animateValue('kpi-reqs', parseInt(document.getElementById('kpi-reqs').textContent.replace(/,/g,'')), s.reqs, 400);
  // Update semantic KPI colors
  const kpiCards = document.querySelectorAll('.kpi-row:first-of-type .kpi-card');
  const statuses = [s.headcountStatus, s.riskStatus, s.contractsStatus, s.reqsStatus];
  kpiCards.forEach((card, i) => {
    card.className = 'kpi-card ' + (statuses[i] || 'green');
  });

  document.getElementById('headcount-badge').textContent = s.headcount.toLocaleString() + ' employees';

  // Breakdown
  const bd = BREAKDOWN_DATA[seg];
  document.getElementById('breakdown-list').innerHTML = bd.map(b => `
    <div class="breakdown-item" onclick="showSegmentPanel('${seg}')">
      <div class="breakdown-meta">
        <div class="breakdown-name"><div class="seg-dot ${b.dotClass}"></div>${b.name}</div>
        <div class="breakdown-count">${b.count.toLocaleString()} · ${b.pct}%</div>
      </div>
      <div class="breakdown-track"><div class="breakdown-fill" style="width:${b.pct}%;background:${b.fillColor}"></div></div>
    </div>
  `).join('');

  // Risk table
  const employees = seg === 'all' ? ALL_EMPLOYEES : ALL_EMPLOYEES.filter(e => e.segment === seg);
  const toShow = employees.slice(0, 5);
  document.getElementById('risk-tbody').innerHTML = toShow.map(e => `
    <tr class="risk-row" onclick="showEmployeePanel(${JSON.stringify(e).replace(/"/g,'&quot;')})">
      <td>
        <div class="name-cell">${e.name}</div>
        <div class="role-cell">${e.role}</div>
      </td>
      <td><span class="segment-chip chip-${e.segment}">${e.segment.charAt(0).toUpperCase() + e.segment.slice(1)}</span></td>
      <td>
        <div class="risk-bar-wrap"><div class="risk-bar" style="width:${e.risk}%;background:${e.risk>70?'var(--red)':'var(--amber)'}"></div></div>
        <div style="font-size:10px;color:${e.risk>70?'var(--red)':'var(--amber)'};font-family:'DM Mono',monospace;margin-top:3px">${e.risk}%</div>
      </td>
      <td style="font-size:11px;color:var(--text-dim)">${e.signal}</td>
    </tr>
  `).join('');

  if (employees.length === 0) {
    document.getElementById('risk-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px">No high-risk employees in this segment</td></tr>';
  }

  // Skills
  const skills = SKILLS_DATA[seg];
  document.getElementById('skills-grid').innerHTML = skills.map(s => `
    <div class="skill-item">
      <div class="skill-name">${s.name}</div>
      <div class="skill-track"><div class="skill-fill" style="width:${s.gap}%;background:${s.color}"></div></div>
      <div class="skill-meta"><span>Gap</span><span style="color:${s.color}">${s.gap}%</span></div>
    </div>
  `).join('');

  updateCharts(seg);
}

function animateValue(id, start, end, duration) {
  const el = document.getElementById(id);
  const startTime = performance.now();
  const update = (now) => {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const value = Math.round(start + (end - start) * eased);
    el.textContent = value.toLocaleString();
    if (progress < 1) requestAnimationFrame(update);
  };
  requestAnimationFrame(update);
}

// ─── CHARTS ──────────────────────────────────────────────────────────────────

const chartDefaults = {
  plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1A1A1A', borderColor: '#2A2A2A', borderWidth: 1, titleColor: '#F0F0F0', bodyColor: '#888888', titleFont: { family: 'DM Mono', size: 11 }, bodyFont: { family: 'DM Sans', size: 11 } } },
  scales: {
    x: { grid: { color: '#1F1F1F' }, ticks: { color: '#555', font: { family: 'DM Mono', size: 10 } } },
    y: { grid: { color: '#1F1F1F' }, ticks: { color: '#555', font: { family: 'DM Mono', size: 10 } } }
  }
};

// ─── ANALYTICS CHART DATA ────────────────────────────────────────────────────

const QUARTERS = ['Q4 24', 'Q1 25', 'Q2 25', 'Q3 25', 'Q4 25', 'Q1 26'];

// Attrition count — raw numbers, differences feel dramatic
const ATTRITION_DATA = {
  all: {
    type: 'bar',
    title: 'Attrition Count by Segment — Last 6 Quarters',
    yLabel: v => v,
    datasets: [
      { label: 'Corporate', data: [48, 52, 61, 44, 39, 42], backgroundColor: 'rgba(52,152,219,0.5)', borderColor: '#3498DB', borderWidth: 1, borderRadius: 3 },
      { label: 'Studio', data: [71, 88, 94, 76, 82, 79], backgroundColor: 'rgba(255,107,107,0.5)', borderColor: '#ff6b6b', borderWidth: 1, borderRadius: 3 },
      { label: 'Union', data: [12, 9, 14, 11, 8, 10], backgroundColor: 'rgba(155,89,182,0.5)', borderColor: '#9B59B6', borderWidth: 1, borderRadius: 3 },
      { label: 'Freelance', data: [84, 102, 118, 95, 108, 97], backgroundColor: 'rgba(243,156,18,0.5)', borderColor: '#F39C12', borderWidth: 1, borderRadius: 3 },
    ]
  },
  corporate: { type: 'bar', title: 'Corporate Attrition Count — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Corporate', data: [48, 52, 61, 44, 39, 42], backgroundColor: 'rgba(52,152,219,0.5)', borderColor: '#3498DB', borderWidth: 1, borderRadius: 3 }] },
  studio: { type: 'bar', title: 'Studio Attrition Count — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Studio', data: [71, 88, 94, 76, 82, 79], backgroundColor: 'rgba(255,107,107,0.5)', borderColor: '#ff6b6b', borderWidth: 1, borderRadius: 3 }] },
  union: { type: 'bar', title: 'Union Attrition Count — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Union', data: [12, 9, 14, 11, 8, 10], backgroundColor: 'rgba(155,89,182,0.5)', borderColor: '#9B59B6', borderWidth: 1, borderRadius: 3 }] },
  freelance: { type: 'bar', title: 'Freelance Attrition Count — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Freelance', data: [84, 102, 118, 95, 108, 97], backgroundColor: 'rgba(243,156,18,0.5)', borderColor: '#F39C12', borderWidth: 1, borderRadius: 3 }] },
};

// Flight risk flagged employees over time
const FLIGHTRISK_DATA = {
  all: {
    type: 'line',
    title: 'Flight Risk Flagged — By Segment Over Time',
    yLabel: v => v,
    datasets: [
      { label: 'Corporate', data: [68, 74, 81, 70, 88, 94], borderColor: '#3498DB', backgroundColor: 'rgba(52,152,219,0.06)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#3498DB' },
      { label: 'Studio', data: [88, 95, 108, 99, 104, 112], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.06)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#ff6b6b' },
      { label: 'Union', data: [28, 31, 38, 34, 40, 42], borderColor: '#9B59B6', backgroundColor: 'rgba(155,89,182,0.06)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#9B59B6' },
      { label: 'Freelance', data: [22, 25, 30, 28, 33, 36], borderColor: '#F39C12', backgroundColor: 'rgba(243,156,18,0.06)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#F39C12' },
    ]
  },
  corporate: { type: 'line', title: 'Corporate Flight Risk Flagged — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Corporate', data: [68, 74, 81, 70, 88, 94], borderColor: '#3498DB', backgroundColor: 'rgba(52,152,219,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#3498DB' }] },
  studio: { type: 'line', title: 'Studio Flight Risk Flagged — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Studio', data: [88, 95, 108, 99, 104, 112], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#ff6b6b' }] },
  union: { type: 'line', title: 'Union Flight Risk Flagged — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Union', data: [28, 31, 38, 34, 40, 42], borderColor: '#9B59B6', backgroundColor: 'rgba(155,89,182,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#9B59B6' }] },
  freelance: { type: 'line', title: 'Freelance Flight Risk Flagged — Last 6 Quarters', yLabel: v => v,
    datasets: [{ label: 'Freelance', data: [22, 25, 30, 28, 33, 36], borderColor: '#F39C12', backgroundColor: 'rgba(243,156,18,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#F39C12' }] },
};

// Time-to-fill in days — horizontal bar makes comparison easy
const TIMETOFILL_DATA = {
  all: {
    type: 'bar',
    horizontal: true,
    title: 'Avg. Time-to-Fill Critical Reqs by Segment (Days) — Q1 2026',
    yLabel: v => v + 'd',
    datasets: [
      { label: 'Time to Fill (days)', data: [38, 67, 91, 44],
        backgroundColor: ['rgba(52,152,219,0.6)', 'rgba(255,107,107,0.6)', 'rgba(155,89,182,0.6)', 'rgba(243,156,18,0.6)'],
        borderColor: ['#3498DB', '#ff6b6b', '#9B59B6', '#F39C12'],
        borderWidth: 1, borderRadius: 4 }
    ],
    labels: ['Corporate', 'Studio', 'Union Crew', 'Freelance'],
  },
  corporate: { type: 'bar', horizontal: true, title: 'Corporate Time-to-Fill by Sub-function (Days)', yLabel: v => v + 'd',
    labels: ['Product & Eng', 'Finance & Legal', 'Marketing', 'People & Culture'],
    datasets: [{ label: 'Days', data: [42, 28, 31, 22], backgroundColor: 'rgba(52,152,219,0.6)', borderColor: '#3498DB', borderWidth: 1, borderRadius: 4 }] },
  studio: { type: 'bar', horizontal: true, title: 'Studio Time-to-Fill by Sub-function (Days)', yLabel: v => v + 'd',
    labels: ['Scripted', 'Post-Production', 'Unscripted', 'Animation'],
    datasets: [{ label: 'Days', data: [72, 88, 54, 61], backgroundColor: 'rgba(255,107,107,0.6)', borderColor: '#ff6b6b', borderWidth: 1, borderRadius: 4 }] },
  union: { type: 'bar', horizontal: true, title: 'Union Crew Time-to-Fill by Guild (Days)', yLabel: v => v + 'd',
    labels: ['SAG-AFTRA', 'IATSE', 'WGA', 'DGA'],
    datasets: [{ label: 'Days', data: [104, 88, 78, 95], backgroundColor: 'rgba(155,89,182,0.6)', borderColor: '#9B59B6', borderWidth: 1, borderRadius: 4 }] },
  freelance: { type: 'bar', horizontal: true, title: 'Freelance Time-to-Fill by Type (Days)', yLabel: v => v + 'd',
    labels: ['Camera & Lighting', 'Sound & Music', 'Editing & Post', 'Writers & Directors'],
    datasets: [{ label: 'Days', data: [38, 29, 44, 52], backgroundColor: 'rgba(243,156,18,0.6)', borderColor: '#F39C12', borderWidth: 1, borderRadius: 4 }] },
};

const CHART_VIEWS = { attrition: ATTRITION_DATA, flightrisk: FLIGHTRISK_DATA, timetofill: TIMETOFILL_DATA };

function switchChart(type) {
  currentChartType = type;
  document.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('toggle-' + type).classList.add('active');
  renderAnalyticsChart(currentSegment, type);
}

function renderAnalyticsChart(seg, type) {
  if (analyticsChart) analyticsChart.destroy();
  const source = CHART_VIEWS[type][seg] || CHART_VIEWS[type]['all'];
  document.getElementById('chart-panel-title').textContent = source.title;

  const isHorizontal = source.horizontal || false;
  const labels = source.labels || QUARTERS;
  const showLegend = source.datasets.length > 1;

  analyticsChart = new Chart(
    document.getElementById('analyticsChart').getContext('2d'),
    {
      type: isHorizontal ? 'bar' : source.type,
      data: { labels, datasets: source.datasets },
      options: {
        ...chartDefaults,
        indexAxis: isHorizontal ? 'y' : 'x',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          ...chartDefaults.plugins,
          legend: { display: showLegend, labels: { color: '#888', font: { family: 'DM Sans', size: 11 }, boxWidth: 12, padding: 16 } }
        },
        scales: {
          x: {
            ...chartDefaults.scales.x,
            ticks: isHorizontal
              ? { ...chartDefaults.scales.x.ticks, callback: source.yLabel }
              : { ...chartDefaults.scales.x.ticks },
            title: (!isHorizontal && type !== 'timetofill')
              ? { display: true, text: 'Quarter', color: '#555555', font: { family: 'DM Mono', size: 10 }, padding: { top: 6 } }
              : { display: false }
          },
          y: {
            ...chartDefaults.scales.y,
            ticks: isHorizontal
              ? { ...chartDefaults.scales.y.ticks }
              : { ...chartDefaults.scales.y.ticks, callback: source.yLabel },
            title: (!isHorizontal)
              ? { display: true, text: type === 'attrition' ? 'Employees Lost' : type === 'flightrisk' ? 'Employees Flagged' : '', color: '#555555', font: { family: 'DM Mono', size: 10 }, padding: { bottom: 6 } }
              : { display: false }
          }
        }
      }
    }
  );
}

function updateCharts(seg) {
  // Small headcount trend chart (top panel)
  if (trendChart) trendChart.destroy();
  const TREND_DATA = {
    all: { data: [11200, 11580, 11900, 12100, 12490, 12847], color: '#E50914' },
    corporate: { data: [3800, 3900, 3980, 4050, 4120, 4210], color: '#3498DB' },
    studio: { data: [3400, 3520, 3630, 3720, 3810, 3890], color: '#ff6b6b' },
    union: { data: [2500, 2530, 2560, 2590, 2620, 2640], color: '#9B59B6' },
    freelance: { data: [1500, 1630, 1730, 1740, 1940, 2107], color: '#F39C12' },
  };
  renderSegmentScorecard(seg);

  // Bottom analytics chart — preserve current toggle selection
  renderAnalyticsChart(seg, currentChartType);
}

// ─── SEGMENT FILTER ───────────────────────────────────────────────────────────

function filterSegment(seg) {
  if (seg !== 'all') {
    showSegmentPanel(seg);
  } else {
    closePanel();
  }
  renderAll(seg);
}

function activateSegment(seg) {
  showSegmentPanel(seg);
  renderAll(seg);
}

// ─── SIDE PANELS ─────────────────────────────────────────────────────────────

function showPanel() {
  document.getElementById('overlay').classList.add('visible');
  document.getElementById('sidePanel').classList.add('visible');
}

function closePanel() {
  document.getElementById('overlay').classList.remove('visible');
  document.getElementById('sidePanel').classList.remove('visible');
}

function showSegmentPanel(seg) {
  if (seg === 'all') { closePanel(); return; }
  const s = SEGMENTS[seg];
  const opps = OPPORTUNITIES[seg] || [];

  document.getElementById('sp-title').textContent = s.label;
  document.getElementById('sp-subtitle').textContent = s.description;
  document.getElementById('sp-chips').innerHTML = `
    <span class="segment-chip chip-${seg}">${seg.toUpperCase()}</span>
    <span style="font-size:11px;color:var(--text-dim)">${s.headcount.toLocaleString()} members</span>
  `;

  document.getElementById('sp-body').innerHTML = `
    <div class="sp-section">
      <div class="sp-section-title">Segment Overview</div>
      <div class="sp-stat-row">
        <div class="sp-stat">
          <div class="sp-stat-label">Headcount</div>
          <div class="sp-stat-value">${s.headcount.toLocaleString()}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Flight Risk (30d)</div>
          <div class="sp-stat-value" style="color:var(--amber)">${s.risk}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Review Cadence</div>
          <div class="sp-stat-value" style="font-size:13px;font-family:'DM Sans',sans-serif">${s.reviewCadence}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Comp Structure</div>
          <div class="sp-stat-value" style="font-size:13px;font-family:'DM Sans',sans-serif">${s.compStructure}</div>
        </div>
      </div>
      ${s.notes ? `<div style="padding:10px 12px;background:rgba(229,9,20,0.08);border:1px solid rgba(229,9,20,0.2);border-radius:5px;font-size:11px;color:var(--text-dim);line-height:1.6">${s.notes}</div>` : ''}
    </div>

    <div class="sp-section">
      <div class="sp-section-title">Top Flight Risk Signals</div>
      <div class="risk-factor-list">
        ${ALL_EMPLOYEES.filter(e => e.segment === seg).slice(0,3).map(e => `
          <div class="risk-factor">
            <div class="risk-factor-dot" style="background:${e.risk>70?'var(--red)':'var(--amber)'}"></div>
            <div class="risk-factor-text"><strong>${e.name}</strong> — ${e.signal}</div>
            <div class="risk-factor-impact">${e.risk}% risk</div>
          </div>
        `).join('') || '<div style="color:var(--text-muted);font-size:12px">No high-risk employees in this segment</div>'}
      </div>
    </div>

    <div class="sp-section">
      <div class="sp-section-title">Development Opportunities</div>
      <div class="opportunity-list">
        ${opps.map(o => `
          <div class="opportunity-item">
            <div class="opp-header">
              <div class="opp-title">${o.title}</div>
              <span class="opp-type ${o.type}">${o.type}</span>
            </div>
            <div class="opp-desc">${o.desc}</div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="action-row">
      <div class="action-btn">Export Report</div>
      <div class="action-btn">Schedule Review</div>
      <div class="action-btn primary">Initiate Outreach</div>
    </div>
  `;

  showPanel();
}

function showEmployeePanel(emp) {
  const opps = OPPORTUNITIES[emp.segment] || [];

  document.getElementById('sp-title').textContent = emp.name;
  document.getElementById('sp-subtitle').textContent = emp.role;
  document.getElementById('sp-chips').innerHTML = `
    <span class="segment-chip chip-${emp.segment}">${emp.segment.toUpperCase()}</span>
    <span style="font-size:11px;color:var(--text-dim)">${emp.location}</span>
    <span style="font-size:11px;color:${emp.risk>70?'var(--red)':'var(--amber)'};font-family:'DM Mono',monospace">${emp.risk}% flight risk</span>
  `;

  document.getElementById('sp-body').innerHTML = `
    <div class="sp-section">
      <div class="sp-section-title">Employee Profile</div>
      <div class="sp-stat-row">
        <div class="sp-stat">
          <div class="sp-stat-label">Tenure</div>
          <div class="sp-stat-value" style="font-size:18px;font-family:'DM Sans',sans-serif">${emp.tenure}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Compensation</div>
          <div class="sp-stat-value" style="font-size:14px;font-family:'DM Sans',sans-serif">${emp.comp}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Last Review</div>
          <div class="sp-stat-value" style="font-size:14px;font-family:'DM Sans',sans-serif">${emp.lastReview}</div>
        </div>
        <div class="sp-stat">
          <div class="sp-stat-label">Engagement</div>
          <div class="sp-stat-value" style="font-size:18px;color:${emp.engagement==='Low'?'var(--red)':emp.engagement==='Medium'?'var(--amber)':'var(--green)'}">${emp.engagement}</div>
        </div>
      </div>
    </div>

    <div class="sp-section">
      <div class="sp-section-title">Risk Factors</div>
      <div class="risk-factor-list">
        <div class="risk-factor">
          <div class="risk-factor-dot" style="background:${emp.risk>70?'var(--red)':'var(--amber)'}"></div>
          <div class="risk-factor-text"><strong>Primary:</strong> ${emp.signal}</div>
          <div class="risk-factor-impact">High</div>
        </div>
        <div class="risk-factor">
          <div class="risk-factor-dot" style="background:var(--amber)"></div>
          <div class="risk-factor-text"><strong>Secondary:</strong> Last review ${emp.lastReview}</div>
          <div class="risk-factor-impact">Medium</div>
        </div>
        <div class="risk-factor">
          <div class="risk-factor-dot" style="background:var(--text-muted)"></div>
          <div class="risk-factor-text"><strong>Context:</strong> ${emp.engagement} engagement score</div>
          <div class="risk-factor-impact">Monitor</div>
        </div>
      </div>
    </div>

    <div class="sp-section">
      <div class="sp-section-title">Recommended Development Opportunities</div>
      <div class="opportunity-list">
        ${opps.slice(0,3).map(o => `
          <div class="opportunity-item">
            <div class="opp-header">
              <div class="opp-title">${o.title}</div>
              <span class="opp-type ${o.type}">${o.type}</span>
            </div>
            <div class="opp-desc">${o.desc}</div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="action-row">
      <div class="action-btn">Add Note</div>
      <div class="action-btn">Schedule 1:1</div>
      <div class="action-btn primary">Flag for Retention</div>
    </div>
  `;

  showPanel();
}

// ─── AI QUERY ────────────────────────────────────────────────────────────────

function setQuery(text) {
  document.getElementById('aiInput').value = text;
  runQuery();
}

async function runQuery() {
  const input = document.getElementById('aiInput').value.trim();
  if (!input) return;

  const responseEl = document.getElementById('aiResponse');
  const textEl = document.getElementById('aiResponseText');
  const btn = document.getElementById('aiBtn');

  responseEl.classList.add('visible');
  btn.disabled = true;
  btn.textContent = '...';
  textEl.innerHTML = '<div style="display:flex;align-items:center;gap:10px;color:var(--text-dim);font-size:13px"><div class="dot-pulse"><span></span><span></span><span></span></div> Analyzing workforce data...</div>';

  const systemPrompt = `You are an AI talent intelligence assistant embedded inside Netflix's internal Workforce Intelligence platform. Netflix has four distinct workforce segments:

1. Corporate (FTE, 4,210 people) — Product, Engineering, Finance, Marketing, People Ops. Annual reviews + quarterly pulse. Salary + equity + bonus.
2. Studio & Content (FTE, 3,890 people) — Scripted, Unscripted, Post-Production, Animation. Project-based reviews + biannual. Salary + project bonus.
3. Union Crew (2,640 people) — SAG-AFTRA, IATSE, WGA, DGA. CBA-governed review/comp/scheduling constraints. Scale rates + residuals.
4. Freelance & Project-based (2,107 people) — DPs, editors, composers, specialist crew. End-of-engagement surveys. Day rates.

Current data: Total headcount 1,871 (112% YoY growth). Flight risk: 67 flagged (30-day window). Post-IPO equity cliff: 287 engineers vesting Q2 2026. Critical open reqs: 31. Segments: Engineering & ML (820), Data Center Ops (540), GTM & Sales (310), Corporate & G&A (201).

Top flight risk employees: Jordan Kim (Studio, 87% risk — no L&D 9mo), Marcus Webb (Studio, 79% — comp below band), Priya Nair (Corporate, 64% — 2 internal apps no move), Lena Torres (Freelance, 58% — contract gap 6wk).

Key skill gaps: Unreal Engine 5 (81%), AI/ML Production (72%), Virtual Production (58%).

Urgent contracts: WGA drama block of 14 writers (12 days), DGA agreement (28 days).

Respond in this exact format — no prose paragraphs:

**Key Findings**
• [bullet with specific data point]
• [bullet with specific data point]
• [bullet with specific data point]

**Recommended Actions**
1. [specific action — owner — timeframe]
2. [specific action — owner — timeframe]
3. [specific action — owner — timeframe]

Be specific. Reference actual names, numbers, and percentages from the data. Maximum 3 bullets per section. Sound like a senior People Analytics leader.`;

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: "user", content: input }]
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || "Unable to retrieve insight. Please try again.";
    textEl.innerHTML = formatAgentText(text);
  } catch (e) {
    textEl.textContent = "AI analysis temporarily unavailable. Please check your connection and try again.";
  }

  btn.disabled = false;
  btn.textContent = 'Ask →';
}

document.getElementById('aiInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') runQuery();
});


// ─── PAGE NAVIGATION ─────────────────────────────────────────────────────────

function showPage(page) {
  ['dashboard','risk','agent','perf','skills','legal'].forEach(p => {
    const el = document.getElementById('page-' + p);
    if (el) el.style.display = p === page ? '' : 'none';
  });
  document.querySelectorAll('.nav-item[id^="nav-"]').forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById('nav-' + page);
  if (navEl) navEl.classList.add('active');
  closePanel();
  if (page === 'risk') renderRiskPage();
  if (page === 'agent') initAgentPage();
  if (page === 'perf') renderPerfPage();
  if (page === 'skills') renderSkillsPage();
  if (page === 'legal') renderLegalPage();
  const titles = { dashboard:'Workforce Dashboard', risk:'Risk & Retention', agent:'Intelligence Agent', perf:'Performance & Feedback', skills:'Skills & Development', legal:'Contracts & Legal' };
  const tb = document.getElementById('topbar-page-title');
  if (tb) tb.textContent = titles[page] || '';
  // Update sync time with realistic stagger per page
  const syncTimes = { dashboard: '5:58 AM', risk: '5:58 AM', agent: 'just now', perf: '5:44 AM', skills: '5:44 AM', legal: '5:58 AM' };
  const syncBadge = document.getElementById('sync-badge');
  if (syncBadge) syncBadge.textContent = 'Synced today at ' + (syncTimes[page] || '5:58 AM');
}

// ─── RISK & RETENTION PAGE DATA ──────────────────────────────────────────────

const ALL_RISK_EMPLOYEES = [
  { name:'Jordan Kim', role:'Sr. Post-Production Sup.', segment:'studio', risk:87, signal:'No L&D activity 9mo', tenure:'3.5 yrs', comp:'$142K (−11% vs band)', lastReview:'14 months ago', engagement:'Low', location:'Los Angeles', interventionStatus:'escalated', interventionNote:'Flagged to HRBP. Comp review initiated.', interventionDate:'Jan 14 2026', factors:['No L&D 9mo','Comp below band','Low engagement'] },
  { name:'Marcus Webb', role:'Lead VFX Artist', segment:'studio', risk:79, signal:'Comp below band midpoint', tenure:'2.1 yrs', comp:'$128K (−14% vs band)', lastReview:'8 months ago', engagement:'Low', location:'Vancouver', interventionStatus:'pending', interventionNote:'Manager notified. 1:1 scheduled for Feb 28.', interventionDate:'Feb 10 2026', factors:['Comp −14% vs band','No internal mobility','Low engagement'] },
  { name:'Priya Nair', role:'Product Manager II', segment:'corporate', risk:64, signal:'2 internal apps, no move', tenure:'2.8 yrs', comp:'$185K (on band)', lastReview:'6 months ago', engagement:'Medium', location:'Los Gatos', interventionStatus:'pending', interventionNote:'Career pathing conversation scheduled.', interventionDate:'Feb 18 2026', factors:['2 internal apps rejected','No promo in 2.8yr','Manager change Q4'] },
  { name:'Lena Torres', role:'DP / Cinematographer', segment:'freelance', risk:58, signal:'Contract gap 6+ weeks', tenure:'1.2 yrs', comp:'$1,800/day', lastReview:'End-of-engagement', engagement:'Medium', location:'New York', interventionStatus:'actioned', interventionNote:'Preferred vendor status offered. Accepted.', interventionDate:'Jan 30 2026', factors:['6wk contract gap','Rate below market','No preferred status'] },
  { name:'Dev Sharma', role:'ML Engineer, Recs', segment:'corporate', risk:52, signal:'LinkedIn activity spike', tenure:'1.9 yrs', comp:'$230K (on band)', lastReview:'5 months ago', engagement:'Medium', location:'Los Gatos', interventionStatus:'none', interventionNote:'', interventionDate:'', factors:['LinkedIn spike','Below-avg perf rating Q3','Team reorg impact'] },
  { name:'Amara Osei', role:'Showrunner', segment:'studio', risk:48, signal:'No internal mobility pitch', tenure:'4.2 yrs', comp:'$310K (on band)', lastReview:'11 months ago', engagement:'Medium', location:'New York', interventionStatus:'none', interventionNote:'', interventionDate:'', factors:['No L&D 11mo','No EP pitch','Review overdue'] },
  { name:'Kenji Watanabe', role:'IATSE Gaffer', segment:'union', risk:44, signal:'CBA rate dispute open', tenure:'2.0 yrs', comp:'Scale rate', lastReview:'CBA-governed', engagement:'Low', location:'Los Angeles', interventionStatus:'pending', interventionNote:'Labor Relations engaged on rate dispute.', interventionDate:'Feb 5 2026', factors:['Open CBA dispute','Low engagement','Consecutive short contracts'] },
  { name:'Sofia Reyes', role:'Sr. Data Scientist', segment:'corporate', risk:38, signal:'Team reorg impact', tenure:'3.1 yrs', comp:'$210K (on band)', lastReview:'4 months ago', engagement:'Medium', location:'Los Gatos', interventionStatus:'actioned', interventionNote:'New team aligned. Skip-level scheduled.', interventionDate:'Feb 12 2026', factors:['Reorg uncertainty','Manager change','Competitor offer rumor'] },
  { name:'Tyler Brooks', role:'Sound Designer', segment:'studio', risk:35, signal:'Project end — no next assignment', tenure:'1.4 yrs', comp:'$98K (on band)', lastReview:'6 months ago', engagement:'Medium', location:'Atlanta', interventionStatus:'none', interventionNote:'', interventionDate:'', factors:['Project ending Mar 2026','No next assignment','Low pipeline visibility'] },
  { name:'Nina Patel', role:'WGA Staff Writer', segment:'union', risk:31, signal:'Contract renewal 45 days', tenure:'2.6 yrs', comp:'WGA scale', lastReview:'CBA-governed', engagement:'High', location:'Los Angeles', interventionStatus:'actioned', interventionNote:'Renewal offer sent. Response pending.', interventionDate:'Feb 20 2026', factors:['Contract expiring','Multi-room interest','Market rate delta'] },
  { name:'James OBrien', role:'Finance Analyst III', segment:'corporate', risk:28, signal:'No promotion in 3yr', tenure:'3.0 yrs', comp:'$140K (on band)', lastReview:'3 months ago', engagement:'Medium', location:'Los Gatos', interventionStatus:'none', interventionNote:'', interventionDate:'', factors:['No promo 3yr','Flat comp growth','Limited visibility to leadership'] },
  { name:'Aisha Kamara', role:'Freelance Editor', segment:'freelance', risk:25, signal:'Declining engagement scores', tenure:'0.8 yrs', comp:'$600/day', lastReview:'End-of-engagement', engagement:'Medium', location:'Remote', interventionStatus:'none', interventionNote:'', interventionDate:'', factors:['Engagement score down 2 engagements','Slower response time','Competitor outreach'] },
];

const RISK_DRIVERS = [
  { rank:'01', name:'Compensation Below Band', desc:'Employees paid below band midpoint are 3.1× more likely to exit within 6 months. Studio VFX and Corporate ML roles show the highest delta vs. market.', impact:91, affectedCount:184 },
  { rank:'02', name:'No L&D Activity (6+ months)', desc:'Employees with no recorded development activity in 6+ months show significantly elevated flight risk, particularly at the 18-36 month tenure band.', impact:78, affectedCount:312 },
  { rank:'03', name:'Stalled Internal Mobility', desc:'Employees who applied for internal roles and were not selected or communicated with show 2.4× elevated risk. 47 employees have 2+ unresolved internal applications.', impact:72, affectedCount:94 },
  { rank:'04', name:'Manager Change in Last 90 Days', desc:'Recent manager transitions correlate with a 34% spike in voluntary departure intent in the 90 days following the change, particularly for tenures under 3 years.', impact:61, affectedCount:228 },
  { rank:'05', name:'Contract Gap > 4 Weeks (Freelance)', desc:'Freelancers with engagement gaps exceeding 4 weeks show a 3× non-return rate. Currently 38 freelancers have gaps exceeding this threshold.', impact:58, affectedCount:38 },
  { rank:'06', name:'LinkedIn Activity Spike', desc:'A 40%+ increase in LinkedIn profile activity (edits, connection growth, post engagement) is a leading indicator for passive job search behavior. 21 employees flagged this quarter.', impact:44, affectedCount:21 },
];

const COHORT_DATA = [
  { label:'0–12 months', pct:71, retainedOf:2840, color:'var(--red)' },
  { label:'1–2 years', pct:82, retainedOf:3210, color:'var(--amber)' },
  { label:'2–4 years', pct:89, retainedOf:4100, color:'var(--green)' },
  { label:'4–6 years', pct:86, retainedOf:1620, color:'var(--green)' },
  { label:'6–10 years', pct:91, retainedOf:890, color:'var(--green)' },
  { label:'10+ years', pct:95, retainedOf:187, color:'var(--blue)' },
];

let riskSortCol = 'risk';
let riskSortDir = -1;
let riskSegFilter = 'all';
let riskStatusFilter = 'all';
let riskSearchTerm = '';

function renderRiskPage() {
  const el = document.getElementById('risk-content');
  el.innerHTML = `
    <!-- Risk KPIs -->
    <div class="kpi-row" style="margin-top:0">
      <div class="kpi-card red">
        <div class="kpi-label">Total Flagged</div>
        <div class="kpi-value">284</div>
        <div class="kpi-sub">30-day window <span class="kpi-delta down">+18 vs last qtr</span></div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Interventions Pending</div>
        <div class="kpi-value">94</div>
        <div class="kpi-sub">Awaiting manager action <span class="kpi-delta down">+7</span></div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Interventions Actioned</div>
        <div class="kpi-value">142</div>
        <div class="kpi-sub">This quarter <span class="kpi-delta up">+22</span></div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Avg. Risk Score</div>
        <div class="kpi-value">54%</div>
        <div class="kpi-sub">Across flagged employees <span class="kpi-delta down">+3pts</span></div>
      </div>
    </div>

    <!-- Predictive Risk Drivers -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Predictive Risk Drivers — Q1 2026</div>
        <div class="panel-action">Methodology →</div>
      </div>
      <div class="panel-body">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
          ${RISK_DRIVERS.map(d => `
            <div class="driver-card">
              <div class="driver-rank">${d.rank}</div>
              <div class="driver-name">${d.name}</div>
              <div class="driver-desc">${d.desc}</div>
              <div class="driver-bar-wrap"><div class="driver-bar-fill" style="width:${d.impact}%"></div></div>
              <div class="driver-impact">Impact score ${d.impact}/100 · ${d.affectedCount} employees affected</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Bottom two panels -->
    <div class="grid-2" style="margin-bottom:0">

      <!-- Retention by Tenure Cohort -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Retention Rate by Tenure Cohort</div>
          <div class="panel-action">Export →</div>
        </div>
        <div class="panel-body">
          ${COHORT_DATA.map(c => `
            <div class="cohort-row">
              <div class="cohort-label">${c.label}</div>
              <div class="cohort-track"><div class="cohort-fill" style="width:${c.pct}%;background:${c.color}"></div></div>
              <div class="cohort-pct" style="color:${c.color}">${c.pct}%</div>
              <div class="cohort-count">${c.retainedOf.toLocaleString()} emp.</div>
            </div>
          `).join('')}
          <div style="margin-top:14px;padding:10px 12px;background:rgba(229,9,20,0.07);border:1px solid rgba(229,9,20,0.18);border-radius:5px;font-size:11px;color:var(--text-dim);line-height:1.6">
            ⚠ 0–12 month cohort retention at 71% — 8pts below target. New hire onboarding and early career pathing are the highest-leverage interventions.
          </div>
        </div>
      </div>

      <!-- Intervention Tracker summary -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Intervention Tracker — Summary</div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          ${[
            { label:'Escalated to HRBP', count:48, color:'var(--red)', pct:17 },
            { label:'Manager 1:1 Scheduled', count:94, color:'var(--amber)', pct:33 },
            { label:'Actioned & Resolved', count:142, color:'var(--green)', pct:50 },
          ].map(s => `
            <div style="display:flex;flex-direction:column;gap:5px">
              <div style="display:flex;justify-content:space-between;font-size:12px">
                <span style="display:flex;align-items:center;gap:7px"><span style="width:8px;height:8px;border-radius:50%;background:${s.color};display:inline-block"></span>${s.label}</span>
                <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim)">${s.count} employees</span>
              </div>
              <div style="height:5px;background:var(--surface3);border-radius:3px;overflow:hidden">
                <div style="width:${s.pct}%;height:100%;background:${s.color};border-radius:3px;transition:width 0.5s ease"></div>
              </div>
            </div>
          `).join('')}
          <div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:10px">Avg. Time to First Intervention</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              ${[
                { seg:'Corporate', days:'8.2 days', color:'var(--blue)' },
                { seg:'Studio', days:'12.4 days', color:'#ff6b6b' },
                { seg:'Union', days:'18.1 days', color:'var(--purple)' },
                { seg:'Freelance', days:'5.6 days', color:'var(--amber)' },
              ].map(t => `
                <div style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:8px 10px">
                  <div style="font-size:10px;color:var(--text-muted);margin-bottom:3px">${t.seg}</div>
                  <div style="font-size:16px;font-family:'DM Serif Display',serif;color:${t.color}">${t.days}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Full Flight Risk Table -->
    <div class="panel" style="margin-top:16px">
      <div class="panel-header" style="flex-wrap:wrap;gap:10px">
        <div class="panel-title">Full Flight Risk Table</div>
        <div class="rr-filter-bar" style="margin-bottom:0">
          <input class="rr-search" id="rr-search" placeholder="Search name or role…" oninput="applyRiskFilters()" />
          <span class="rr-filter-label">Segment:</span>
          <select class="rr-filter-select" id="rr-seg" onchange="applyRiskFilters()">
            <option value="all">All</option>
            <option value="corporate">Corporate</option>
            <option value="studio">Studio</option>
            <option value="union">Union</option>
            <option value="freelance">Freelance</option>
          </select>
          <span class="rr-filter-label">Status:</span>
          <select class="rr-filter-select" id="rr-status" onchange="applyRiskFilters()">
            <option value="all">All</option>
            <option value="escalated">Escalated</option>
            <option value="pending">Pending</option>
            <option value="actioned">Actioned</option>
            <option value="none">No Action</option>
          </select>
        </div>
      </div>
      <div class="panel-body" style="padding:0 18px">
        <table class="full-risk-table">
          <thead>
            <tr>
              <th onclick="sortRiskTable('name')">Employee <span class="sort-icon">↕</span></th>
              <th onclick="sortRiskTable('segment')">Segment <span class="sort-icon">↕</span></th>
              <th onclick="sortRiskTable('risk')" class="sorted">Risk Score <span class="sort-icon">↓</span></th>
              <th>Primary Factors</th>
              <th onclick="sortRiskTable('interventionStatus')">Intervention <span class="sort-icon">↕</span></th>
              <th onclick="sortRiskTable('tenure')">Tenure <span class="sort-icon">↕</span></th>
            </tr>
          </thead>
          <tbody id="full-risk-tbody"></tbody>
        </table>
        <div id="rr-empty" style="display:none;text-align:center;padding:28px;color:var(--text-muted);font-size:13px">No employees match the current filters.</div>
      </div>
    </div>
  `;

  applyRiskFilters();
}

function applyRiskFilters() {
  const search = (document.getElementById('rr-search')?.value || '').toLowerCase();
  const seg = document.getElementById('rr-seg')?.value || 'all';
  const status = document.getElementById('rr-status')?.value || 'all';

  let filtered = ALL_RISK_EMPLOYEES.filter(e => {
    const matchSearch = !search || e.name.toLowerCase().includes(search) || e.role.toLowerCase().includes(search);
    const matchSeg = seg === 'all' || e.segment === seg;
    const matchStatus = status === 'all' || e.interventionStatus === status;
    return matchSearch && matchSeg && matchStatus;
  });

  filtered.sort((a, b) => {
    let va = a[riskSortCol], vb = b[riskSortCol];
    if (riskSortCol === 'tenure') { va = parseFloat(va); vb = parseFloat(vb); }
    if (va < vb) return riskSortDir;
    if (va > vb) return -riskSortDir;
    return 0;
  });

  const tbody = document.getElementById('full-risk-tbody');
  const empty = document.getElementById('rr-empty');
  if (!tbody) return;

  if (filtered.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  const statusLabels = { escalated:'Escalated', pending:'Pending', actioned:'Actioned', none:'No Action' };
  const statusClasses = { escalated:'status-escalated', pending:'status-pending', actioned:'status-actioned', none:'status-none' };

  tbody.innerHTML = filtered.map(e => `
    <tr onclick="showEmployeePanel(${JSON.stringify(e).replace(/"/g,'&quot;')})">
      <td>
        <div class="emp-name">${e.name}</div>
        <div class="emp-role">${e.role} · ${e.location}</div>
      </td>
      <td><span class="segment-chip chip-${e.segment}">${e.segment.charAt(0).toUpperCase()+e.segment.slice(1)}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="risk-bar-wrap" style="width:60px"><div class="risk-bar" style="width:${e.risk}%;background:${e.risk>70?'var(--red)':e.risk>50?'var(--amber)':'var(--green)'}"></div></div>
          <span style="font-size:11px;font-family:'DM Mono',monospace;color:${e.risk>70?'var(--red)':e.risk>50?'var(--amber)':'var(--green)'}">${e.risk}%</span>
        </div>
      </td>
      <td>${e.factors.map(f => `<span class="risk-factor-tag">${f}</span>`).join('')}</td>
      <td>
        <div class="intervention-status ${statusClasses[e.interventionStatus]}">${statusLabels[e.interventionStatus]}</div>
        ${e.interventionDate ? `<div style="font-size:10px;color:var(--text-muted);margin-top:3px;font-family:'DM Mono',monospace">${e.interventionDate}</div>` : ''}
      </td>
      <td style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text-dim)">${e.tenure}</td>
    </tr>
  `).join('');
}

function sortRiskTable(col) {
  if (riskSortCol === col) { riskSortDir *= -1; }
  else { riskSortCol = col; riskSortDir = col === 'risk' ? -1 : 1; }
  document.querySelectorAll('.full-risk-table th').forEach(th => {
    th.classList.remove('sorted');
    const icon = th.querySelector('.sort-icon');
    if (icon) icon.textContent = '↕';
  });
  const cols = ['name','segment','risk','','interventionStatus','tenure'];
  const idx = cols.indexOf(col);
  if (idx >= 0) {
    const ths = document.querySelectorAll('.full-risk-table th');
    ths[idx].classList.add('sorted');
    const icon = ths[idx].querySelector('.sort-icon');
    if (icon) icon.textContent = riskSortDir === -1 ? '↓' : '↑';
  }
  applyRiskFilters();
}


// ─── SEGMENT HEALTH SCORECARD ────────────────────────────────────────────────

const SCORECARD_DATA = {
  all: {
    rows: [
      { label: 'Avg. Tenure', value: '2.8 yrs', sub: 'Across all segments', signal: null },
      { label: 'Retention Rate', value: '86%', sub: 'Rolling 12 months', signal: { color: 'var(--amber)', text: '−2pts QoQ' } },
      { label: 'Flight Risk Rate', value: '2.2%', sub: '284 of 12,847 flagged', signal: { color: 'var(--red)', text: '↑ trending up' } },
      { label: 'L&D Participation', value: '61%', sub: 'Active in program', signal: { color: 'var(--green)', text: '+4pts QoQ' } },
      { label: 'Open Critical Reqs', value: '43', sub: 'Blocking production', signal: { color: 'var(--amber)', text: '−5 vs last qtr' } },
      { label: 'Avg. Time-to-Fill', value: '58d', sub: 'Critical roles only', signal: { color: 'var(--red)', text: '↑ +6d vs target' } },
    ]
  },
  corporate: {
    rows: [
      { label: 'Avg. Tenure', value: '3.4 yrs', sub: 'Corporate FTEs', signal: null },
      { label: 'Retention Rate', value: '91%', sub: 'Rolling 12 months', signal: { color: 'var(--green)', text: 'On target' } },
      { label: 'Flight Risk Rate', value: '2.2%', sub: '94 of 4,210 flagged', signal: { color: 'var(--amber)', text: '↑ slight increase' } },
      { label: 'L&D Participation', value: '74%', sub: 'Active in program', signal: { color: 'var(--green)', text: '+6pts QoQ' } },
      { label: 'Promo Rate (12mo)', value: '18%', sub: 'IC promotions', signal: { color: 'var(--amber)', text: 'Below 22% target' } },
      { label: 'Avg. Time-to-Fill', value: '38d', sub: 'Critical roles only', signal: { color: 'var(--green)', text: 'On target' } },
    ]
  },
  studio: {
    rows: [
      { label: 'Avg. Tenure', value: '2.4 yrs', sub: 'Studio FTEs', signal: null },
      { label: 'Retention Rate', value: '85%', sub: 'Rolling 12 months', signal: { color: 'var(--amber)', text: '−3pts QoQ' } },
      { label: 'Flight Risk Rate', value: '2.9%', sub: '112 of 3,890 flagged', signal: { color: 'var(--red)', text: 'Highest segment' } },
      { label: 'L&D Participation', value: '52%', sub: 'Active in program', signal: { color: 'var(--red)', text: '9pts below avg' } },
      { label: 'Pilot Season Readiness', value: '78%', sub: 'Crew coverage Q2', signal: { color: 'var(--amber)', text: '↑ improving' } },
      { label: 'Avg. Time-to-Fill', value: '67d', sub: 'Critical roles only', signal: { color: 'var(--red)', text: '↑ +11d vs target' } },
    ]
  },
  union: {
    rows: [
      { label: 'Avg. Tenure', value: '3.1 yrs', sub: 'Union crew members', signal: null },
      { label: 'Return Rate', value: '94%', sub: 'Re-engaged last 12mo', signal: { color: 'var(--green)', text: 'Strongest segment' } },
      { label: 'Active CBAs', value: '4', sub: 'SAG, IATSE, WGA, DGA', signal: { color: 'var(--amber)', text: '2 renegotiating' } },
      { label: 'CBA Compliance', value: '100%', sub: 'No violations on record', signal: { color: 'var(--green)', text: 'Clean quarter' } },
      { label: 'Rate Disputes Open', value: '3', sub: 'Pending resolution', signal: { color: 'var(--amber)', text: 'Labor Relations engaged' } },
      { label: 'Avg. Time-to-Fill', value: '91d', sub: 'Governed by CBA', signal: { color: 'var(--red)', text: 'Structural constraint' } },
    ]
  },
  freelance: {
    rows: [
      { label: 'Avg. Engagement', value: '13 wks', sub: 'Per engagement', signal: { color: 'var(--amber)', text: '−5wk vs prior yr' } },
      { label: 'Return Rate', value: '71%', sub: 'Re-engaged within 6mo', signal: { color: 'var(--amber)', text: '−4pts YoY' } },
      { label: 'Preferred Vendor %', value: '34%', sub: 'Of active freelancers', signal: { color: 'var(--green)', text: '+8pts QoQ' } },
      { label: 'Avg. Gap Duration', value: '3.2 wks', sub: 'Between engagements', signal: { color: 'var(--amber)', text: 'Above 2wk threshold' } },
      { label: 'Contract Gap >4wk', value: '38', sub: 'At non-return risk', signal: { color: 'var(--red)', text: 'Needs outreach' } },
      { label: 'Avg. Time-to-Fill', value: '44d', sub: 'Specialist roles', signal: { color: 'var(--amber)', text: 'On watch' } },
    ]
  },
};

function renderSegmentScorecard(seg) {
  const el = document.getElementById('segment-scorecard');
  if (!el) return;
  const data = SCORECARD_DATA[seg] || SCORECARD_DATA['all'];
  el.innerHTML = `
    <div style="font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);font-family:'DM Mono',monospace;margin-bottom:8px;font-weight:600">Segment Health</div>
    <div class="scorecard-grid">
      ${data.rows.map(r => `
        <div class="scorecard-cell" style="cursor:default">
          <div class="scorecard-cell-label">${r.label}</div>
          <div class="scorecard-cell-value">${r.value}</div>
          ${r.signal
            ? `<div class="scorecard-signal"><div class="scorecard-signal-dot" style="background:${r.signal.color}"></div><span style="color:${r.signal.color}">${r.signal.text}</span></div>`
            : `<div class="scorecard-cell-sub">${r.sub}</div>`
          }
        </div>
      `).join('')}
    </div>
  `;
}


// ─── INTELLIGENCE AGENT ──────────────────────────────────────────────────────

const AGENT_SYSTEM_PROMPT = `You are a senior Talent Intelligence Agent embedded inside CoreWeave's internal workforce platform, Lattice. You have deep access to the following live data:

WORKFORCE SNAPSHOT (Q1 2026):
- Total headcount: 1,871 (112% YoY growth) across 4 segments
- Engineering & ML: 820 | Data Center Ops: 540 | GTM & Sales: 310 | Corporate & G&A: 201
- Overall retention: 81% (rolling 12mo) — down 4pts QoQ, driven by post-IPO equity vesting
- Flight risk flagged: 67 employees (3.6% rate) — up 11 from last quarter
- Critical open reqs: 31 (18 Engineering, 9 DC Ops, 3 GTM, 1 G&A)
- Post-IPO equity cliff: 287 engineers vesting RSUs in Q2 2026 — highest attrition risk window

SEGMENT HEALTH SIGNALS:
- Engineering & ML: Highest flight risk rate (4.6%). 34% of cohort hitting equity cliff Q2 2026. Avg time-to-fill 94d. 18 reqs blocking cluster launches.
- Data Center Ops: Rapid expansion (13 → 32 facilities in 12mo) creating onboarding volume pressure. L&D participation at 49%. Safety cert renewals overdue for 62 technicians.
- GTM & Sales: Microsoft >62% revenue concentration creates single-account dependency risk. 2 AEs with stalled internal transfer requests. Commission plan update due Q2.
- Corporate & G&A: Post-IPO SOX compliance build causing workload spike. HRBP team understaffed vs headcount growth rate. New hire onboarding cycle time 22 days (target: 10).

TOP FLIGHT RISK EMPLOYEES:
- Aiden Park (Engineering, 89%): Equity cliff Q2 + 3 recruiter contacts. Comp 9% below band. No intervention yet.
- Riya Desai (Engineering, 76%): Comp 12% below band, LinkedIn spike. Manager notified, no action taken.
- Marcus Chen (GTM, 61%): 2 internal transfer requests not actioned in 90 days. Career pathing overdue.
- Fatima Al-Hassan (DC Ops, 54%): No L&D activity 8mo + site expansion stress. HRBP flagged.

PREDICTIVE RISK DRIVERS (ranked by impact):
1. Post-IPO equity cliff (96/100 impact, 287 employees vesting Q2 2026)
2. Comp below band (88/100, 142 employees)
3. No L&D activity 6mo+ (74/100, 218 employees)
4. Stalled internal mobility (69/100, 47 employees)
5. LinkedIn activity spike (52/100, 19 employees)
6. Rapid team growth / reorg disruption (44/100, 340 employees in new or restructured teams)

SKILLS GAPS (critical for infrastructure scale):
- Blackwell GPU hardware: 82% gap (DC Ops)
- GPU architecture & tuning: 78% gap (Engineering)
- AI/ML infrastructure design: 71% gap (Engineering)
- Kubernetes operators: 65% gap (Engineering)
- SOX compliance: 74% gap (G&A)

CONTRACT & LEGAL PIPELINE:
- Active contracts in Ironclad: 847 (employment, vendor, NDA, SaaS)
- Contracts due for renewal in 90 days: 134
- Overdue reviews: 23 (avg 18 days past SLA)
- AI-assisted contract reviews completed this quarter: 312 (37% of total)
- Avg contract cycle time: 14.2 days (target: 7 days)
- SOX evidence requests pending: 8 (Q4 audit prep)

HIRE-TO-RETIRE PIPELINE HEALTH:
- Time-to-hire (Engineering): 94 days | Target: 60 days
- Time-to-hire (DC Ops): 41 days | Target: 30 days
- Onboarding completion rate: 72% complete by day 30 (target: 95%)
- Internal mobility applications actioned: 43% (target: 70%)
- Performance review completion: 78% on-cycle (target: 92%)

INTERVENTION TRACKER:
- 31 escalated to HRBP | 22 pending manager action | 14 actioned & resolved
- Avg time to first intervention: Engineering 6.4d, DC Ops 9.1d, GTM 4.2d, G&A 3.8d

You must respond ONLY with a valid JSON object. No preamble, no markdown, no backticks. The JSON must exactly match the schema provided in the user message.`;

const AGENT_MODES = [
  { id: 'exec', icon: '◈', label: 'Executive Summary', badge: 'Board-ready' },
  { id: 'hrbp', icon: '◎', label: 'HRBP Actions', badge: 'Operational' },
  { id: 'pm', icon: '◇', label: 'Platform Health', badge: 'Admin' },
  { id: 'patterns', icon: '△', label: 'Pattern Detection', badge: 'Analytical' },
];

let agentInitialized = false;
let agentCurrentMode = 'exec';
let agentCache = {};

function initAgentPage() {
  const el = document.getElementById('agent-content');
  el.innerHTML = `
    <div class="agent-hero">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="agent-hero-label"><div class="agent-pulse"></div> Intelligence Agent · Live</div>
        <button class="agent-refresh-btn" onclick="refreshAgentMode()">↻ Refresh analysis</button>
      </div>
      <div class="agent-hero-title">Lattice Intelligence Agent</div>
      <div class="agent-hero-sub">Digests all workforce data in real time and surfaces actionable insights for HRBPs, executives, and product decisions. Powered by Claude.</div>
      <div class="agent-meta">
        <div class="agent-meta-item">⬡ <span>1,871 employees · 4 segments</span></div>
        <div class="agent-meta-item">◎ <span>67 flight risk signals</span></div>
        <div class="agent-meta-item">△ <span>6 predictive drivers</span></div>
        <div class="agent-meta-item">◈ <span>Q1 2026 workforce data</span></div>
        <div class="agent-meta-item" id="agent-last-run">○ <span>Last run: just now</span></div>
      </div>
    </div>

    <div class="agent-mode-tabs">
      ${AGENT_MODES.map(m => `
        <div class="agent-mode-tab ${m.id === agentCurrentMode ? 'active' : ''}" id="agent-tab-${m.id}" onclick="switchAgentMode('${m.id}')">
          <span class="agent-mode-icon">${m.icon}</span>
          <span class="agent-tab-label">${m.label}</span>
          <span class="agent-tab-badge">${m.badge}</span>
        </div>
      `).join('')}
    </div>

    <div id="agent-output-area"></div>
  `;

  runAgentMode(agentCurrentMode);
}

function switchAgentMode(mode) {
  agentCurrentMode = mode;
  document.querySelectorAll('.agent-mode-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('agent-tab-' + mode).classList.add('active');
  if (agentCache[mode]) {
    renderAgentOutput(mode, agentCache[mode]);
  } else {
    runAgentMode(mode);
  }
}

function refreshAgentMode() {
  delete agentCache[agentCurrentMode];
  runAgentMode(agentCurrentMode);
}

function showAgentLoading(mode) {
  const steps = {
    exec: ['Aggregating segment health signals…', 'Scoring business risks by severity…', 'Drafting executive narrative…', 'Structuring board-ready output…'],
    hrbp: ['Scanning flight risk table…', 'Prioritizing by urgency and impact…', 'Generating outreach recommendations…', 'Assigning owners and deadlines…'],
    pm: ['Scanning platform usage patterns…', 'Identifying capability gaps in the data…', 'Sizing impact by user segment…', 'Generating platform health report…'],
    patterns: ['Running cross-segment correlation…', 'Detecting anomalies vs. prior quarters…', 'Surfacing non-obvious patterns…', 'Validating signal strength…'],
  };
  const stepList = steps[mode] || steps.exec;
  const area = document.getElementById('agent-output-area');
  area.innerHTML = `
    <div class="agent-loading-screen">
      <div class="dot-pulse" style="justify-content:center;margin-bottom:16px"><span></span><span></span><span></span></div>
      <div style="font-size:13px;color:var(--text-dim)">Agent is analyzing workforce data…</div>
      <div class="agent-loading-steps" id="agent-steps">
        ${stepList.map((s, i) => `
          <div class="agent-step" id="agent-step-${i}">
            <span class="agent-step-icon">○</span> ${s}
          </div>
        `).join('')}
      </div>
    </div>
  `;
  // Animate steps
  stepList.forEach((_, i) => {
    setTimeout(() => {
      const prev = document.getElementById('agent-step-' + (i-1));
      if (prev) { prev.classList.remove('active'); prev.classList.add('done'); prev.querySelector('.agent-step-icon').textContent = '✓'; }
      const cur = document.getElementById('agent-step-' + i);
      if (cur) { cur.classList.add('active'); cur.querySelector('.agent-step-icon').textContent = '›'; }
    }, i * 600);
  });
}

const AGENT_PROMPTS = {
  exec: `Return a JSON object with this exact schema:
{
  "summary": "3-sentence board-level narrative of the most critical workforce risks and opportunities this quarter",
  "insights": [
    {
      "title": "insight title",
      "priority": "CRITICAL|HIGH|MEDIUM",
      "finding": "use bullet points starting with • for each key data point, max 3 bullets",
      "actions": [
        { "text": "specific action", "owner": "who owns it", "due": "timeframe" }
      ]
    }
  ]
}
Include exactly 4 insights ordered by priority. Focus on risks with board-level implications: post-IPO equity cliff attrition, engineering talent supply chain for cluster launches, SOX compliance readiness, and contract lifecycle SLA exposure.`,

  hrbp: `Return ONLY a raw JSON object (no markdown, no backticks, no explanation) with this structure:
{"summary":"string","insights":[{"title":"string","priority":"CRITICAL","finding":"string","actions":[{"text":"string","owner":"string","due":"string"}]}]}

Rules: priority must be one of CRITICAL, HIGH, or MEDIUM. Include exactly 5 insights ordered by urgency. Be specific — name employees from the data (Aiden Park, Riya Desai, Marcus Chen, Fatima Al-Hassan etc), quote actual numbers. Focus on: flight risk interventions, post-IPO equity cliff actions, comp corrections, contract SLA breaches, and onboarding gaps. Each insight should have 2-3 actions.`,

  pm: `You are the Staff PM who owns Lattice — CoreWeave's People Tech and Legal systems platform (HRIS, ATS, performance, CLM, onboarding, compensation). This is your platform health view. Use the workforce data to evaluate where the platform stack is creating friction, missing automation, or failing compliance requirements. Return ONLY a raw JSON object with this structure:
{"summary":"string","insights":[{"title":"string","priority":"CRITICAL","finding":"string","actions":[{"text":"string","owner":"string","due":"string"}]}]}

Rules: priority must be one of CRITICAL, HIGH, or MEDIUM. Include exactly 5 insights. Frame each as a platform gap you own — covering the hire-to-retire lifecycle: time-to-hire latency in ATS, onboarding automation gaps, contract CLM SLA breaches, SOX control coverage in Workday, GenAI automation opportunities in Ironclad or HR workflows, and internal mobility tooling gaps. Each insight should have 2-3 specific build actions with owners (PM, Eng, IT/Integrations, Legal Ops, Data Science) and quarters. Think like a Staff PM at a post-IPO AI infrastructure company.`,

  patterns: `Return a JSON object with this exact schema:
{
  "summary": "2-sentence summary of the most surprising or non-obvious pattern you detected across the workforce data",
  "patterns": [
    {
      "label": "pattern name",
      "finding": "1-2 short sentences max — be crisp and direct",
      "signal": "the specific data point or correlation that reveals it",
      "signalColor": "var(--red)|var(--amber)|var(--green)|var(--blue)"
    }
  ]
}
Include exactly 6 patterns. Look for: cross-segment correlations, leading vs lagging indicators, counterintuitive findings, trends that contradict conventional wisdom, and signals that a human analyst reviewing dashboards would likely miss.`,
};

async function runAgentMode(mode) {
  showAgentLoading(mode);
  const totalSteps = 4;
  const callDelay = (totalSteps - 1) * 600 + 400;

  await new Promise(r => setTimeout(r, callDelay));

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: AGENT_SYSTEM_PROMPT,
        messages: [{ role: 'user', content: AGENT_PROMPTS[mode] }]
      })
    });
    const data = await res.json();
    let text = data.content?.[0]?.text || '';
    // Robustly extract JSON - find first { to last }
    const firstBrace = text.indexOf('{');
    const lastBrace = text.lastIndexOf('}');
    if (firstBrace === -1 || lastBrace === -1) throw new Error('No JSON object found in response: ' + text.substring(0, 200));
    text = text.substring(firstBrace, lastBrace + 1);
    const parsed = JSON.parse(text);
    agentCache[mode] = parsed;
    // Update last run time
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  const lastRun = document.getElementById('agent-last-run');
  if (lastRun) lastRun.innerHTML = '○ <span>Last run: ' + timeStr + '</span>';
  renderAgentOutput(mode, parsed);
  } catch(e) {
    console.error('Agent error:', e);
    document.getElementById('agent-output-area').innerHTML = `
      <div style="padding:24px;text-align:center;color:var(--text-muted);font-size:13px;background:var(--surface);border:1px solid var(--border);border-radius:8px">
        Agent error: ${e.message}
        <br><br><button class="agent-refresh-btn" onclick="refreshAgentMode()">↻ Try Again</button>
      </div>`;
  }
}

function renderAgentOutput(mode, data) {
  const area = document.getElementById('agent-output-area');
  const priorities = { CRITICAL: 'critical', HIGH: 'high', MEDIUM: 'medium' };

  let html = `
    <div style="background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--red);border-radius:6px;padding:14px 18px;margin-bottom:20px;font-size:13px;line-height:1.75;color:var(--text)">
      <div style="font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--red);font-family:'DM Mono',monospace;margin-bottom:6px;font-weight:600">Agent Summary</div>
      ${formatAgentText(data.summary)}
    </div>
  `;

  if (mode === 'patterns' && data.patterns) {
    html += `<div class="pattern-grid">
      ${data.patterns.map(p => `
        <div class="pattern-card">
          <div class="pattern-card-label">${p.label}</div>
          <div class="pattern-card-finding">${formatAgentText(p.finding)}</div>
          <div class="pattern-card-signal" style="color:${p.signalColor || 'var(--text-dim)'}">◆ ${p.signal}</div>
        </div>
      `).join('')}
    </div>`;
  } else if (data.insights) {
    html += data.insights.map((ins, idx) => {
      const pKey = priorities[ins.priority] || 'medium';
      const isFirst = idx === 0;
      return `
        <div class="insight-card">
          <div class="insight-card-header" onclick="toggleInsight(this)">
            <div class="insight-card-header-left">
              <div class="insight-priority priority-${pKey}">${idx + 1}</div>
              <div class="insight-card-title">${ins.title}</div>
              <span class="insight-card-badge badge-${pKey}">${ins.priority}</span>
            </div>
            <div class="insight-chevron ${isFirst ? 'open' : ''}">▾</div>
          </div>
          <div class="insight-card-body ${isFirst ? 'open' : ''}">
            <div class="insight-finding">${formatAgentText(ins.finding)}</div>
            <div style="font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);font-family:'DM Mono',monospace;margin-bottom:8px">Recommended Actions</div>
            <div class="insight-actions">
              ${(ins.actions || []).map((a, ai) => `
                <div class="insight-action-item">
                  <div class="insight-action-num">${ai + 1}</div>
                  <div class="insight-action-text">
                    <div>${a.text}</div>
                    <div class="insight-action-owner">Owner: ${a.owner}</div>
                  </div>
                  <div class="insight-action-due">${a.due}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  area.innerHTML = `<div class="agent-output visible">${html}</div>`;
}

function toggleInsight(header) {
  const body = header.nextElementSibling;
  const chevron = header.querySelector('.insight-chevron');
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  chevron.classList.toggle('open', !isOpen);
}


// ─── PERFORMANCE & FEEDBACK PAGE ─────────────────────────────────────────────

const PERF_DATA = {
  reviewStatus: [
    { segment: 'Corporate', cadence: 'Annual + quarterly pulse', completion: 88, overdue: 42, upcoming: 310, color: 'var(--blue)', chip: 'chip-corporate' },
    { segment: 'Studio FTE', cadence: 'Project-based + biannual', completion: 71, overdue: 89, upcoming: 204, color: '#ff6b6b', chip: 'chip-studio' },
    { segment: 'Union Crew', cadence: 'CBA-governed only', completion: 100, overdue: 0, upcoming: 0, color: 'var(--purple)', chip: 'chip-union', note: 'Reviews restricted by CBA' },
    { segment: 'Freelance', cadence: 'End-of-engagement', completion: 64, overdue: 0, upcoming: 87, color: 'var(--amber)', chip: 'chip-freelance', note: 'Triggered at contract close' },
  ],
  overdueEmployees: [
    { name: 'Amara Osei', role: 'Showrunner', segment: 'studio', lastReview: '11 months ago', manager: 'VP Content, Drama', urgency: 'high' },
    { name: 'Jordan Kim', role: 'Sr. Post-Production Sup.', segment: 'studio', lastReview: '14 months ago', manager: 'Head of Post', urgency: 'critical' },
    { name: 'Tyler Brooks', role: 'Sound Designer', segment: 'studio', lastReview: '9 months ago', manager: 'VP Post-Production', urgency: 'high' },
    { name: 'James OBrien', role: 'Finance Analyst III', segment: 'corporate', lastReview: '13 months ago', manager: 'Finance Director', urgency: 'high' },
    { name: 'Priya Nair', role: 'Product Manager II', segment: 'corporate', lastReview: '6 months ago', manager: 'Sr. Director, Product', urgency: 'medium' },
    { name: 'Dev Sharma', role: 'ML Engineer, Recs', segment: 'corporate', lastReview: '5 months ago', manager: 'Sr. Director, ML', urgency: 'medium' },
  ],
  feedbackHealth: [
    { label: 'Upward feedback submitted', value: 74, color: 'var(--green)' },
    { label: 'Peer feedback completion', value: 68, color: 'var(--green)' },
    { label: 'Manager feedback completion', value: 81, color: 'var(--green)' },
    { label: 'Self-assessment completion', value: 58, color: 'var(--amber)' },
    { label: 'Reviews actioned by manager', value: 43, color: 'var(--red)' },
    { label: 'Follow-up 1:1 scheduled', value: 39, color: 'var(--red)' },
  ],
};

function renderPerfPage() {
  const el = document.getElementById('perf-content');
  const urgencyColors = { critical: 'var(--red)', high: 'var(--amber)', medium: 'var(--blue)' };
  const urgencyLabels = { critical: 'CRITICAL', high: 'HIGH', medium: 'MEDIUM' };

  el.innerHTML = `
    <div class="kpi-row" style="margin-top:0">
      <div class="kpi-card amber">
        <div class="kpi-label">Reviews Overdue</div>
        <div class="kpi-value">131</div>
        <div class="kpi-sub">Across corporate + studio <span class="kpi-delta down">+22 vs last qtr</span></div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Overall Completion</div>
        <div class="kpi-value">81%</div>
        <div class="kpi-sub">Reviews completed on time <span class="kpi-delta up">+3pts</span></div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Reviews Not Actioned</div>
        <div class="kpi-value">57%</div>
        <div class="kpi-sub">No follow-up 1:1 scheduled <span class="kpi-delta down">Needs attention</span></div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Upcoming (30 days)</div>
        <div class="kpi-value">601</div>
        <div class="kpi-sub">Across all segments <span class="kpi-delta up">On track</span></div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:16px">
      <!-- Review status by segment -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Review Cycle Status by Segment</div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          ${PERF_DATA.reviewStatus.map(s => `
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px 14px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <div style="display:flex;align-items:center;gap:8px">
                  <span class="segment-chip ${s.chip}">${s.segment.toUpperCase()}</span>
                  <span style="font-size:11px;color:var(--text-dim)">${s.cadence}</span>
                </div>
                <span style="font-size:12px;font-family:'DM Mono',monospace;color:${s.color}">${s.completion}% complete</span>
              </div>
              <div style="height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-bottom:8px">
                <div style="width:${s.completion}%;height:100%;background:${s.color};border-radius:2px"></div>
              </div>
              <div style="display:flex;gap:16px;font-size:11px;color:var(--text-muted)">
                ${s.overdue > 0 ? `<span style="color:var(--red)">⚠ ${s.overdue} overdue</span>` : ''}
                ${s.upcoming > 0 ? `<span>◷ ${s.upcoming} upcoming</span>` : ''}
                ${s.note ? `<span style="color:var(--text-muted);font-style:italic">${s.note}</span>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Feedback health -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Feedback Health — Q1 2026</div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:12px">
          ${PERF_DATA.feedbackHealth.map(f => `
            <div>
              <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px">
                <span>${f.label}</span>
                <span style="font-family:'DM Mono',monospace;color:${f.color}">${f.value}%</span>
              </div>
              <div style="height:4px;background:var(--surface3);border-radius:2px;overflow:hidden">
                <div style="width:${f.value}%;height:100%;background:${f.color};border-radius:2px"></div>
              </div>
            </div>
          `).join('')}
          <div style="margin-top:8px;padding:10px 12px;background:rgba(229,9,20,0.07);border:1px solid rgba(229,9,20,0.18);border-radius:5px;font-size:11px;color:var(--text-dim);line-height:1.6">
            ⚠ Only 39% of completed reviews have a follow-up 1:1 scheduled. Reviews without follow-up action correlate with a 2.1× increase in 90-day flight risk.
          </div>
        </div>
      </div>
    </div>

    <!-- Overdue reviews table -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Overdue Reviews — Action Required</div>
        <div class="panel-action">Notify All Managers →</div>
      </div>
      <div class="panel-body" style="padding:0 18px">
        <table class="full-risk-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Segment</th>
              <th>Last Review</th>
              <th>Manager</th>
              <th>Urgency</th>
            </tr>
          </thead>
          <tbody>
            ${PERF_DATA.overdueEmployees.map(e => `
              <tr onclick="showEmployeePanel(${JSON.stringify({name:e.name,role:e.role,segment:e.segment,tenure:'—',comp:'—',lastReview:e.lastReview,engagement:'—',location:'—',risk:0,signal:'Review overdue'}).replace(/"/g,'&quot;')})" style="cursor:pointer">
                <td>
                  <div class="emp-name">${e.name}</div>
                  <div class="emp-role">${e.role}</div>
                </td>
                <td><span class="segment-chip chip-${e.segment}">${e.segment.charAt(0).toUpperCase()+e.segment.slice(1)}</span></td>
                <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim)">${e.lastReview}</td>
                <td style="font-size:12px;color:var(--text-dim)">${e.manager}</td>
                <td>
                  <span style="font-size:10px;font-family:'DM Mono',monospace;font-weight:600;padding:3px 8px;border-radius:3px;background:${urgencyColors[e.urgency]}22;color:${urgencyColors[e.urgency]}">${urgencyLabels[e.urgency]}</span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ─── SKILLS & DEVELOPMENT PAGE ────────────────────────────────────────────────

const SKILLS_PAGE_DATA = {
  programs: [
    { name: 'Unreal Engine 5 Intensive', type: 'Technical', segment: 'studio', enrolled: 48, capacity: 60, gap: 81, status: 'Active', statusColor: 'var(--green)', provider: 'Epic Games / ARRI' },
    { name: 'AI/ML Product Immersion', type: 'Product', segment: 'corporate', enrolled: 31, capacity: 40, gap: 72, status: 'Active', statusColor: 'var(--green)', provider: 'Internal / Anthropic' },
    { name: 'Virtual Production Cert.', type: 'Technical', segment: 'studio', enrolled: 22, capacity: 30, gap: 58, status: 'Active', statusColor: 'var(--green)', provider: 'Netflix Learning' },
    { name: 'SAG Compliance Workshop', type: 'Compliance', segment: 'union', enrolled: 64, capacity: 80, gap: 50, status: 'Active', statusColor: 'var(--green)', provider: 'Labor Relations' },
    { name: 'Executive Presence', type: 'Leadership', segment: 'corporate', enrolled: 18, capacity: 25, gap: 38, status: 'Waitlist', statusColor: 'var(--amber)', provider: 'Korn Ferry' },
    { name: 'Post-Production AI Tools', type: 'Technical', segment: 'studio', enrolled: 0, capacity: 40, gap: 65, status: 'Planned Q2', statusColor: 'var(--text-muted)', provider: 'TBD' },
  ],
  noActivity: [
    { name: 'Jordan Kim', role: 'Sr. Post-Production Sup.', segment: 'studio', lastActivity: '9+ months', riskLink: 87 },
    { name: 'Amara Osei', role: 'Showrunner', segment: 'studio', lastActivity: '11 months', riskLink: 48 },
    { name: 'Kenji Watanabe', role: 'IATSE Gaffer', segment: 'union', lastActivity: '8 months', riskLink: 44 },
    { name: 'James OBrien', role: 'Finance Analyst III', segment: 'corporate', lastActivity: '7 months', riskLink: 28 },
    { name: 'Tyler Brooks', role: 'Sound Designer', segment: 'studio', lastActivity: '6 months', riskLink: 35 },
    { name: 'Sofia Reyes', role: 'Sr. Data Scientist', segment: 'corporate', lastActivity: '6 months', riskLink: 38 },
  ],
  segmentLd: [
    { segment: 'Corporate', pct: 74, enrolled: 3115, color: 'var(--blue)' },
    { segment: 'Studio FTE', pct: 52, enrolled: 2023, color: '#ff6b6b' },
    { segment: 'Union Crew', pct: 41, enrolled: 1082, color: 'var(--purple)' },
    { segment: 'Freelance', pct: 38, enrolled: 801, color: 'var(--amber)' },
  ],
};

function renderSkillsPage() {
  const el = document.getElementById('skills-content');

  el.innerHTML = `
    <div class="kpi-row" style="margin-top:0">
      <div class="kpi-card green">
        <div class="kpi-label">Overall L&amp;D Participation</div>
        <div class="kpi-value">61%</div>
        <div class="kpi-sub">7,021 employees enrolled <span class="kpi-delta up">+4pts QoQ</span></div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">No Activity (6mo+)</div>
        <div class="kpi-value">312</div>
        <div class="kpi-sub">Top flight risk driver <span class="kpi-delta down">Needs outreach</span></div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Critical Skill Gaps</div>
        <div class="kpi-value">6</div>
        <div class="kpi-sub">Blocking next slate <span class="kpi-delta down">UE5 most urgent</span></div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Active Programs</div>
        <div class="kpi-value">4</div>
        <div class="kpi-sub">2 planned for Q2 <span class="kpi-delta up">On track</span></div>
      </div>
    </div>

    <!-- L&D by segment + skills gap -->
    <div class="grid-2" style="margin-bottom:16px">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">L&amp;D Participation by Segment</div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px">
          ${SKILLS_PAGE_DATA.segmentLd.map(s => `
            <div>
              <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px">
                <span style="font-weight:500">${s.segment}</span>
                <span style="font-family:'DM Mono',monospace;color:${s.color}">${s.pct}% · ${s.enrolled.toLocaleString()} enrolled</span>
              </div>
              <div style="height:8px;background:var(--surface3);border-radius:4px;overflow:hidden">
                <div style="width:${s.pct}%;height:100%;background:${s.color};border-radius:4px"></div>
              </div>
            </div>
          `).join('')}
          <div style="margin-top:4px;padding:10px 12px;background:rgba(255,107,107,0.07);border:1px solid rgba(255,107,107,0.2);border-radius:5px;font-size:11px;color:var(--text-dim);line-height:1.6">
            Studio FTE participation at 52% is 9pts below org average. Low L&D is the #2 flight risk driver — targeted outreach to studio employees with no recent activity is the highest-leverage intervention.
          </div>
        </div>
      </div>

      <!-- Skills gap full list -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Skills Gaps — Next Slate</div>
          <div class="panel-action">Export →</div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          ${[
            { name: 'Unreal Engine 5', gap: 81, segment: 'Studio', color: 'var(--red)' },
            { name: 'AI/ML Production', gap: 72, segment: 'Studio', color: 'var(--red)' },
            { name: 'Post-Production AI', gap: 65, segment: 'Studio', color: 'var(--red)' },
            { name: 'Virtual Production', gap: 58, segment: 'Studio', color: 'var(--amber)' },
            { name: 'SAG Compliance', gap: 50, segment: 'Union', color: 'var(--amber)' },
            { name: 'AI/ML Product Mgmt', gap: 68, segment: 'Corporate', color: 'var(--red)' },
          ].map(s => `
            <div style="display:flex;align-items:center;gap:12px">
              <div style="flex:1">
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
                  <span style="font-weight:500">${s.name}</span>
                  <span style="font-family:'DM Mono',monospace;font-size:11px;color:${s.color}">${s.gap}% gap</span>
                </div>
                <div style="height:4px;background:var(--surface3);border-radius:2px;overflow:hidden">
                  <div style="width:${s.gap}%;height:100%;background:${s.color};border-radius:2px"></div>
                </div>
              </div>
              <span class="segment-chip chip-${s.segment.toLowerCase()}" style="white-space:nowrap">${s.segment.toUpperCase()}</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Programs table -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Active &amp; Planned Programs</div>
        <div class="panel-action">Add Program →</div>
      </div>
      <div class="panel-body" style="padding:0 18px">
        <table class="full-risk-table">
          <thead>
            <tr>
              <th>Program</th>
              <th>Type</th>
              <th>Segment</th>
              <th>Enrollment</th>
              <th>Gap Addressed</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${SKILLS_PAGE_DATA.programs.map(p => {
              const enrollPct = Math.round(p.enrolled / p.capacity * 100);
              return `
              <tr>
                <td>
                  <div class="emp-name">${p.name}</div>
                  <div class="emp-role">${p.provider}</div>
                </td>
                <td style="font-size:11px;color:var(--text-dim)">${p.type}</td>
                <td><span class="segment-chip chip-${p.segment}">${p.segment.toUpperCase()}</span></td>
                <td>
                  <div style="font-size:11px;font-family:'DM Mono',monospace;margin-bottom:4px">${p.enrolled}/${p.capacity} seats</div>
                  <div style="width:80px;height:3px;background:var(--surface3);border-radius:2px;overflow:hidden">
                    <div style="width:${enrollPct}%;height:100%;background:var(--green);border-radius:2px"></div>
                  </div>
                </td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px">
                    <div style="width:28px;height:3px;background:var(--surface3);border-radius:2px;overflow:hidden">
                      <div style="width:${p.gap}%;height:100%;background:${p.gap>70?'var(--red)':'var(--amber)'};border-radius:2px"></div>
                    </div>
                    <span style="font-size:11px;font-family:'DM Mono',monospace;color:${p.gap>70?'var(--red)':'var(--amber)'}">${p.gap}%</span>
                  </div>
                </td>
                <td><span style="font-size:10px;font-family:'DM Mono',monospace;font-weight:600;color:${p.statusColor}">${p.status}</span></td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- No activity employees -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">No L&amp;D Activity (6+ months) — Flight Risk Link</div>
        <div class="panel-action">Send Outreach →</div>
      </div>
      <div class="panel-body" style="padding:0 18px">
        <table class="full-risk-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Segment</th>
              <th>Last Activity</th>
              <th>Flight Risk</th>
            </tr>
          </thead>
          <tbody>
            ${SKILLS_PAGE_DATA.noActivity.map(e => `
              <tr onclick="showEmployeePanel(${JSON.stringify({name:e.name,role:e.role,segment:e.segment,tenure:'—',comp:'—',lastReview:'—',engagement:'Low',location:'—',risk:e.riskLink,signal:'No L&D activity'}).replace(/"/g,'&quot;')})" style="cursor:pointer">
                <td>
                  <div class="emp-name">${e.name}</div>
                  <div class="emp-role">${e.role}</div>
                </td>
                <td><span class="segment-chip chip-${e.segment}">${e.segment.charAt(0).toUpperCase()+e.segment.slice(1)}</span></td>
                <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim)">${e.lastActivity}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:8px">
                    <div class="risk-bar-wrap" style="width:60px"><div class="risk-bar" style="width:${e.riskLink}%;background:${e.riskLink>70?'var(--red)':'var(--amber)'}"></div></div>
                    <span style="font-size:11px;font-family:'DM Mono',monospace;color:${e.riskLink>70?'var(--red)':'var(--amber)'}">${e.riskLink}%</span>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}


// ─── TEXT FORMATTER ───────────────────────────────────────────────────────────

function formatAgentText(text) {
  if (!text) return '';
  // Process line by line for reliable bullet/number detection
  const lines = text.split('\n');
  const out = [];
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];
    // Bold **text**
    line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Section header (bold standalone line)
    if (/^<strong>.+<\/strong>$/.test(line.trim())) {
      out.push('<div style="font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);font-family:\'DM Mono\',monospace;font-weight:600;margin:10px 0 5px">' + line.replace(/<\/?strong>/g,'') + '</div>');
    }
    // Bullet • or -
    else if (/^[•\-] /.test(line)) {
      out.push('<div style="display:flex;gap:8px;margin:3px 0;font-size:12px"><span style="color:var(--red);flex-shrink:0;margin-top:2px;font-size:9px">◆</span><span>' + line.replace(/^[•\-] /,'') + '</span></div>');
    }
    // Numbered item
    else if (/^\d+\.\s/.test(line)) {
      const num = line.match(/^(\d+)\./)[1];
      const rest = line.replace(/^\d+\.\s*/,'');
      out.push('<div style="display:flex;gap:8px;margin:3px 0;font-size:12px"><span style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--red);flex-shrink:0;width:14px;margin-top:3px">' + num + '.</span><span>' + rest + '</span></div>');
    }
    // Empty line
    else if (line.trim() === '') {
      out.push('<div style="height:4px"></div>');
    }
    // Normal text
    else {
      out.push('<span style="font-size:12px;line-height:1.7">' + line + '</span>');
    }
  }
  return out.join('');
}

// ─── LEGAL PAGE ──────────────────────────────────────────────────────────────

function renderLegalPage() {
  const el = document.getElementById('legal-content');
  if (!el || el.innerHTML.trim()) return;

  const contractPipeline = [
    { label: 'Active (in review)', count: 847, pct: 100, color: 'var(--red)' },
    { label: 'AI-assisted review', count: 312, pct: 37, color: '#0057FF' },
    { label: 'Pending legal sign-off', count: 94, pct: 11, color: 'var(--amber)' },
    { label: 'Overdue (past SLA)', count: 23, pct: 3, color: 'var(--red)' },
    { label: 'Executed (Q1 2026)', count: 401, pct: 47, color: 'var(--green)' },
  ];

  const complianceRows = [
    { name: 'SOX Evidence Requests', status: '8 pending', color: 'var(--red)', note: 'Q4 FY2025 close' },
    { name: 'SOC 2 Control Coverage', status: '84%', color: 'var(--amber)', note: 'Target: 100% by Q2' },
    { name: 'Data Privacy Reviews', status: '3 overdue', color: 'var(--amber)', note: 'CPRA / GDPR gap' },
    { name: 'Workday Access Audits', status: 'Current', color: 'var(--green)', note: 'Last run: Jan 2026' },
    { name: 'Offboarding Completion', status: '91%', color: 'var(--green)', note: '9% missing asset return' },
  ];

  const overdueContracts = [
    { name: 'Microsoft Infrastructure MSA', type: 'Vendor', owner: 'Legal — Enterprise', sla: 'Q4 close', days: 31, status: 'Escalated', color: 'var(--red)' },
    { name: 'NDA — Potential Hire, Eng L7', type: 'NDA', owner: 'TA + Legal', sla: '5d SLA', days: 22, status: 'Pending Review', color: 'var(--red)' },
    { name: 'Offer Letter — Aiden Park', type: 'Employment', owner: 'HR Ops', sla: '3d SLA', days: 14, status: 'Pending Sign', color: 'var(--amber)' },
    { name: 'AWS Cross-Cloud Agreement', type: 'Vendor', owner: 'Legal — Infra', sla: '14d SLA', days: 11, status: 'In AI Review', color: 'var(--amber)' },
    { name: 'SaaS Renewal — Workato', type: 'SaaS', owner: 'IT + Finance', sla: '10d SLA', days: 8, status: 'Pending Approval', color: 'var(--amber)' },
  ];

  const pipelineStages = [
    { stage: 'Time-to-Hire (Eng)', value: '94d', target: '60d', status: 'red', note: '18 reqs open' },
    { stage: 'Time-to-Hire (DC Ops)', value: '41d', target: '30d', status: 'amber', note: '9 reqs open' },
    { stage: 'Onboarding Day-30', value: '72%', target: '95%', status: 'red', note: '22d avg cycle' },
    { stage: 'Internal Mobility', value: '43%', target: '70%', status: 'red', note: '47 apps pending' },
    { stage: 'Perf Review On-cycle', value: '78%', target: '92%', status: 'amber', note: 'Engineering lag' },
    { stage: 'Offboarding Complete', value: '91%', target: '100%', status: 'amber', note: 'Asset return gap' },
  ];

  const stageColor = s => s === 'red' ? 'var(--red)' : s === 'amber' ? 'var(--amber)' : 'var(--green)';

  el.innerHTML = `
    <div class="kpi-row" style="margin-top:0">
      <div class="kpi-card red">
        <div class="kpi-label">Overdue Reviews</div>
        <div class="kpi-value">23</div>
        <div class="kpi-sub">Avg 18d past SLA <span class="kpi-delta down">+8 vs Q4</span></div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Renewals Due (90d)</div>
        <div class="kpi-value">134</div>
        <div class="kpi-sub">Employment, vendor, NDA <span class="kpi-delta down">+22 vs Q4</span></div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">AI-Assisted Reviews</div>
        <div class="kpi-value">37%</div>
        <div class="kpi-sub">312 of 847 contracts <span class="kpi-delta up">+14pts</span></div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Avg Cycle Time</div>
        <div class="kpi-value">14.2d</div>
        <div class="kpi-sub">Target: 7 days <span class="kpi-delta down">2× target</span></div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:20px">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Contract Pipeline Status</div>
          <div class="panel-action">Ironclad sync ✓</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:4px">
          ${contractPipeline.map(r => `
            <div>
              <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                <span style="font-size:12px;color:var(--text)">${r.label}</span>
                <span style="font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted)">${r.count}</span>
              </div>
              <div style="background:var(--surface3);border-radius:3px;height:5px">
                <div style="background:${r.color};height:5px;border-radius:3px;width:${r.pct}%"></div>
              </div>
            </div>
          `).join('')}
        </div>
        <div style="margin-top:16px;padding:12px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--red)">
          <div style="font-size:11px;font-weight:600;color:var(--red);margin-bottom:4px">⚠ SLA Alert</div>
          <div style="font-size:12px;color:var(--text-dim);line-height:1.6">23 contracts are past SLA (avg 18 days overdue). At current cycle time of 14.2d, the 134 renewals due in 90 days will create a Q2 bottleneck. AI-assisted review reduced cycle time by 6.4 days for the 37% of contracts processed through the pipeline.</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Compliance & Controls Health</div>
          <div class="panel-action">Q4 Audit Prep</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:4px">
          ${complianceRows.map(r => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
              <div>
                <div style="font-size:12px;color:var(--text);font-weight:500">${r.name}</div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${r.note}</div>
              </div>
              <div style="font-size:12px;font-weight:600;color:${r.color};font-family:'IBM Plex Mono',monospace">${r.status}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:20px">
      <div class="panel-header">
        <div class="panel-title">Overdue Contract Reviews</div>
        <div class="panel-action">Export →</div>
      </div>
      <table class="data-table">
        <thead><tr>
          <th>Contract</th><th>Type</th><th>Owner</th><th>SLA</th><th>Days Overdue</th><th>Status</th>
        </tr></thead>
        <tbody>
          ${overdueContracts.map(r => `
            <tr>
              <td style="font-weight:500">${r.name}</td>
              <td><span style="font-size:10px;padding:2px 7px;border-radius:3px;background:var(--surface3);color:var(--text-muted);font-family:'IBM Plex Mono',monospace">${r.type}</span></td>
              <td style="color:var(--text-dim);font-size:12px">${r.owner}</td>
              <td style="color:var(--text-muted);font-size:12px">${r.sla}</td>
              <td style="font-family:'IBM Plex Mono',monospace;color:${r.color};font-weight:600">${r.days}d</td>
              <td><span style="font-size:10px;padding:2px 8px;border-radius:3px;background:var(--surface3);border:1px solid ${r.color};color:${r.color}">${r.status}</span></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <div class="panel" style="margin-top:20px">
      <div class="panel-header">
        <div class="panel-title">Hire-to-Retire Pipeline Health</div>
        <div class="panel-action">Full view →</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:4px">
        ${pipelineStages.map(r => `
          <div style="padding:14px;background:var(--surface2);border-radius:6px;border:1px solid var(--border);border-bottom:2px solid ${stageColor(r.status)}">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">${r.stage}</div>
            <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:${stageColor(r.status)}">${r.value}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Target: ${r.target} · ${r.note}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// ─── INIT ────────────────────────────────────────────────────────────────────
renderAll('all');
</script>
</body>
</html>
